<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>UnityShader学习总结：基础初级篇 | 墨墨辰的旋转小屋</title><meta name="author" content="墨墨辰,473059480@qq.com"><meta name="copyright" content="墨墨辰"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言上个月读了《Unity Shader 入门精要》这本书，原本准备将学习笔记整理一下，作为博文发布出来，复习的时候检查了一下。发现很大程度上与书籍内容相同，有点抄书的嫌疑，想了想还是决定整理归纳一下，顺便查缺补漏，看看有没有被遗落的知识点，内容极其主观，特此声明。  基础部分：渲染流水线与Unity Sahder基础这本书的基础部分主要是由渲染流水线的介绍和Unity Shader的基础写法构成">
<meta property="og:type" content="article">
<meta property="og:title" content="UnityShader学习总结：基础初级篇">
<meta property="og:url" content="http://example.com/2023/10/07/UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/index.html">
<meta property="og:site_name" content="墨墨辰的旋转小屋">
<meta property="og:description" content="前言上个月读了《Unity Shader 入门精要》这本书，原本准备将学习笔记整理一下，作为博文发布出来，复习的时候检查了一下。发现很大程度上与书籍内容相同，有点抄书的嫌疑，想了想还是决定整理归纳一下，顺便查缺补漏，看看有没有被遗落的知识点，内容极其主观，特此声明。  基础部分：渲染流水线与Unity Sahder基础这本书的基础部分主要是由渲染流水线的介绍和Unity Shader的基础写法构成">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://the-black-sun-imgs.pages.dev/Img/1最初的梦想.jpg">
<meta property="article:published_time" content="2023-10-07T11:58:04.000Z">
<meta property="article:modified_time" content="2023-10-07T13:28:46.315Z">
<meta property="article:author" content="墨墨辰">
<meta property="article:tag" content="Unity">
<meta property="article:tag" content="Shader">
<meta property="article:tag" content="图形渲染">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://the-black-sun-imgs.pages.dev/Img/1最初的梦想.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="http://example.com/2023/10/07/UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 墨墨辰","link":"链接: ","source":"来源: 墨墨辰的旋转小屋","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'UnityShader学习总结：基础初级篇',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-07 21:28:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><link rel="stylesheet" href="/css/icon.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/loading.gif" data-original="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 墨墨辰的收集画册</span></a></li><li><a class="site-page child" href="/studio/"><i class="fa-fw iconfont icon-huabi"></i><span> 墨墨辰的手残画室</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 墨墨辰的音乐收集记录</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://the-black-sun-imgs.pages.dev/Img/1最初的梦想.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="墨墨辰的旋转小屋"><span class="site-name">墨墨辰的旋转小屋</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 墨墨辰的收集画册</span></a></li><li><a class="site-page child" href="/studio/"><i class="fa-fw iconfont icon-huabi"></i><span> 墨墨辰的手残画室</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 墨墨辰的音乐收集记录</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">UnityShader学习总结：基础初级篇</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-07T11:58:04.000Z" title="发表于 2023-10-07 19:58:04">2023-10-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-10-07T13:28:46.315Z" title="更新于 2023-10-07 21:28:46">2023-10-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%9B%BE%E5%BD%A2%E5%AD%A6/">图形学</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>50分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="UnityShader学习总结：基础初级篇"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上个月读了《Unity Shader 入门精要》这本书，原本准备将学习笔记整理一下，作为博文发布出来，复习的时候检查了一下。发现很大程度上与书籍内容相同，有点抄书的嫌疑，想了想还是决定整理归纳一下，顺便查缺补漏，看看有没有被遗落的知识点，内容极其主观，特此声明。</p>
<hr>
<h1 id="基础部分：渲染流水线与Unity-Sahder基础"><a href="#基础部分：渲染流水线与Unity-Sahder基础" class="headerlink" title="基础部分：渲染流水线与Unity Sahder基础"></a>基础部分：渲染流水线与Unity Sahder基础</h1><p>这本书的基础部分主要是由渲染流水线的介绍和Unity Shader的基础写法构成的。这部分内容主要分布在全书的第2章与第3章。第一章主要介绍了一下全书内容结构，并没有涉及到太多的知识点。第4章主要介绍一些涉及图形学相关的数学知识，关于这部分内容，想要深入学习的同学可以去阅读一下相关书籍《3D游戏数学》。这本书详细介绍了3d游戏中，涉及图形学的数学概念，各个空间变换所需要的矩阵计算方法的底层原理等等。</p>
<h2 id="渲染流水线"><a href="#渲染流水线" class="headerlink" title="渲染流水线"></a>渲染流水线</h2><p>由于在大学期间学习过龙书（<strong><strong>DirectX12 3D游戏开发实战</strong></strong>），还跟着老师写过论文（混），所以对渲染流水线还是有着基本上的认识的，虽然DirectX12的渲染流水线与Unity的渲染存在一定程度上的差别，但是基础原理与专有名词还是相同的，对理解起来不会存在太大的难度。</p>
<p>在unity的渲染流水线中主要分为以下3个阶段：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled.png" alt="Untitled"></p>
<p>分别是应用阶段，几何阶段以及光栅化阶段。其中应用阶段主要由CPU进行控制的，而几何阶段以及光栅化阶段则主要由GPU进行控制。</p>
<p><code>应用阶段</code>是CPU的工作阶段，由上图可以看出主要是负责将渲染图元（几何信息，顶点数据）提交给GPU并请求渲染。具体的工作这是：</p>
<ul>
<li>准备好场景数据（摄像机位置、模型、光源等等），进行粗粒度剔除的工作（根据视锥体剔除不可见物体），将不可见物体CPU首先需要将所需要的数据加载进显存当中（大多数显卡缺少对内存的访问权限）；</li>
<li>设置好渲染状态（告诉GPU这个渲染物体使用的材质，纹理，shader等等），会得到一个待渲染的几何信息，也就是<code>渲染图元</code>，在待渲染的图元列表中；</li>
<li>向GPU发送请求渲染命令，指向一个待渲染的图元列表，通知GPU进行渲染。</li>
</ul>
<p>这一部分的大部分工作能够在Unity的图形化界面上进行操作，包括但不限于：调整场景中物体（顶点，法线）位置，设置纹理（颜色、透明度调整）等等⇒部分纹理属性需要再在shader中定义对应属性。除此之外还有一部分需要再unity的Shader文件中进行设置，例如渲染状态等等。而CPU每次提交渲染图元，向GPU发出的一个请求渲染的命令就是通常开发者们熟悉的<code>DrawCall</code>。而通常对DrawCall的优化就是需要减少CPU发出的渲染命令，也就是减少图元列表，这通常也就需要使用到我们常说的<code>合批</code>与<code>图集</code>了，这里先不进行表述。</p>
<p><code>几何阶段</code>与<code>光栅化阶段</code>也就是我们需要重点关注的部分。内部可以细分成多个阶段，如下表所示：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled1.png" alt="Untitled"></p>
<p><code>几何阶段</code>主要包括以下几个步骤：</p>
<p>顶点着色器：完全可编程。以单个顶点为单位进行处理，主要完成顶点坐标变换，逐顶点光照，计算顶点颜色等功能。</p>
<p>曲面细分着色器：完全可编程，可选。主要用来设置与生成高精度网格（细分图元）。</p>
<p>几何着色器：完全可编程，可选。进行逐图元的着色操作，或者产生更多的图元。</p>
<p>剪裁：可配置。（注意与CPU的粗粒度剔除的区别）将摄像机视锥体范围外的<code>物体部分</code>剔除（产生新顶点替代边界）。</p>
<p>屏幕映射：不可配置，不可编程。将图元坐标由齐次剪裁空间转化到屏幕坐标系中。</p>
<p><code>光栅化阶段</code>主要包括以下几个步骤：</p>
<p>三角形设置：不可配置，不可编程。根据几何阶段输出的顶点信息，获取三角形每条边的像素坐标，得到三角形边界的表达方式。</p>
<p>三角形遍历：不可配置，不可编程。检查像素点是否被三角网格覆盖，并生成片元（包括屏幕坐标，深度，发现，纹理等信息）。</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled2.png" alt="Untitled"></p>
<p>片元着色器：完全可编程。进行纹理采样，实现逐片元的着色操作。</p>
<p>逐片元操作：高度可配置。进行颜色修改，可见性测试（深度检测，模板检测），混合等操作。</p>
<ul>
<li>模板检测：将片元模板缓冲区的模板值与设置的参考值比较，比较函数由开发者指定，判断是否通过模板测试。</li>
<li>深度检测：将片元深度缓冲区的深度值与片元的深度值比较，比较函数由开发者指定，判断是否通过深度测试。如果通过深度测试，才有覆盖深度缓冲区值的权利，开发者可以选择是否覆盖（开启/关闭深度写入）</li>
<li>等等等等</li>
</ul>
<p>由上面介绍，可以看见有关于于<code>完全可编程</code>，<code>可配置</code>等等的字样。这些说明了开发者能够控制内部实现又或是能够配置对应阶段的相关属性，并且这些都是需要再Unity Shader文件中通过代码进行实现。在书中，后面章节主要通过使用了顶点着色器与片元着色器以及部分配置功能来实现效果，至于曲面细分着色器与几何着色器的使用，有兴趣的可以参考官网内容进行学习。</p>
<p>UnityShader文件主要通过类CG语言进行编写，由以上介绍可知，我们能够在顶点着色器，曲面细分着色器，几何着色器以及片元着色器中进行具体的效果实现，同时可以配置剪裁或逐片元操作的混合、深度写入等功能。</p>
<p>书中该部分内容还介绍了两大图形接口（OpenGL与DirectX），三大着色语言（HLSL、GLSL、CG）DrawCall，以及固定渲染管线的相关知识，与具体实现Shader相关效果联系不大，这里不做过多的介绍。</p>
<h2 id="Unity-Shader基础"><a href="#Unity-Shader基础" class="headerlink" title="Unity Shader基础"></a>Unity Shader基础</h2><p>该部分内容主要是书中第3章部分内容，主要介绍了UnityShader的整体结构。需要注意的是Shader是和材质相互绑定的，Unity中创建材质会自动绑定默认Shader，可以通过Unity界面上进行调整。</p>
<p>常见的UnityShader使用流程：</p>
<ul>
<li>创建一个材质</li>
<li>创建一个unity shader，并赋给材质</li>
<li>将材质赋给要渲染的对象</li>
<li>在材质面板调整Unity Shader中的属性</li>
</ul>
<p>需要注意的是，还存在其他情况的Shader使用情况，例如涉及到屏幕截取以及后处理等功能时（第12章），会通过代码创建材质并将相应Shader进行材质设置，不遵照上述使用流程。</p>
<p>除此之外，创建UnityShader文件还需要注意以下几种Unity的内置模板：</p>
<ul>
<li>Standard Surface Shader：一个包含标准光照模型的表面着色器模板。</li>
<li>Unlit Shader：一个不包含光效，但是包含雾效的基本的顶点/片元着色器</li>
<li>Image Effect Shader：一个用来处理各种屏幕后处理效果的模板</li>
<li>Compute Shader（例外）：利用GPU并行性进行一些与流水线无关计算的模板（白嫖计算量）</li>
<li>Ray Tracing Shader：一个光线追踪shader</li>
</ul>
<p>以下是2个常用Shader着色器的特点：</p>
<ul>
<li>表面着色器：代码量少，渲染代价大（unity实现的时候需要转换成顶点/片元着色器，相当于上层），unity内部自动处理光照细节<ul>
<li>不需要写Pass，最表层接口不关心（只实现什么纹理填充什么颜色，法线，使用什么光照模型等，进行表面渲染）</li>
<li>代码定义在CGPROGRAM与ENDCG之间</li>
<li>使用CG/HLSL语法</li>
<li>与光源打交道可以优先使用</li>
</ul>
</li>
<li>顶点/片元着色器：更加复杂，灵活性高<ul>
<li>代码定义在CGPROGRAM与ENDCG之间</li>
<li>需要写在Pass语义块中，需要自定义每个Pass使用的shader代码</li>
<li>使用CG/HLSL语法</li>
<li>需要许多自定义的渲染效果</li>
<li>和较少的光源打交道</li>
</ul>
</li>
</ul>
<p>在之后的学习的过程中主要采用创建使用了Unlit Shader模版（通过编写顶点/片元着色器实现具体特效效果，包括下列代码实例也是）。还有可能使用的Shader面板的相关设置：</p>
<ul>
<li>Default Maps：shader使用的默认纹理</li>
<li>Show generated code：unity为shader模板（我们创建的）生成的顶点/片元着色器代码。</li>
<li>Compile and show code（下拉列表）：直接点击查看底层汇编指令。下拉列表查看不同图形接口生成编译的shader代码。</li>
<li>其余信息：渲染队列（Render queue）情况，批处理（Disable batching）情况、属性列表等</li>
</ul>
<p>接下来就是Unity Shader代码文件的大概结构了：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Shader名称，在跨Shader文件使用的时候会用到</span></span><br><span class="line">Shader &quot;ShaderName&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="comment">//属性，定义纹理，颜色，透明度等纹理相关属性，</span></span><br><span class="line">		<span class="comment">//会在Unity材质面板上进行显示，根据设置能够调整对应参数</span></span><br><span class="line">		<span class="comment">//名字|显示的名称|类型|赋值</span></span><br><span class="line">        <span class="comment">//_Color (&quot;Color&quot;, Color) = (1,1,1,1)</span></span><br><span class="line">        <span class="comment">//_MainTex (&quot;Albedo (RGB)&quot;, 2D) = &quot;white&quot; &#123;&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//显卡A使用的子着色器（顶点/片元），在内部定义</span></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="comment">//可选标签，控制整个SubShader</span></span><br><span class="line">		<span class="comment">//设置渲染对列，渲染类型</span></span><br><span class="line">		<span class="comment">//[Tags]</span></span><br><span class="line">		<span class="comment">//Tags &#123;&quot;Queue&quot;=&quot;Transparent&quot; &quot;IgnoreProjector&quot;=&quot;True&quot; &quot;RenderType&quot;=&quot;Transparent&quot;&#125;</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//可选状态，控制整个SubShader</span></span><br><span class="line">		<span class="comment">//设置剔除模式，深度测试函数时，深度写入开关，以及混合模式</span></span><br><span class="line">		<span class="comment">//[RenderSetup]</span></span><br><span class="line">		<span class="comment">//Cull Back</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//结构,Pass可以定义多个</span></span><br><span class="line">		Pass&#123;</span><br><span class="line">			[Name]</span><br><span class="line">			[Tags]</span><br><span class="line">			[RenderSetup]</span><br><span class="line">			<span class="comment">//Other code </span></span><br><span class="line">		&#125;</span><br><span class="line">				</span><br><span class="line">		<span class="comment">//实际写法</span></span><br><span class="line">		Pass&#123;</span><br><span class="line">			<span class="comment">//名称，ShaderLab可以使用UsePass命令来使用其他shader的pass。</span></span><br><span class="line">			<span class="comment">//跨Shader文件调用时会用到</span></span><br><span class="line">			Name &quot;MyPassName&quot;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//UsePass使用方法，使用其他shader的pass。</span></span><br><span class="line">			UsePass &quot;MyShader/MYPASSNAME&quot;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//GrabPass使用方法，用来抓取屏幕并存储成一张纹理，用于后续的Pass处理。</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">//标签,这里的标签与Subshader不同，是用来设置怎么渲染的</span></span><br><span class="line">			Tags &#123;&quot;LightMode&quot;=&quot;ForwardBase&quot;&#125;</span><br><span class="line">			<span class="comment">//定义pass在渲染流水线中的角色</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">//状态，除了SubShader的状态之外，还有设置固定管线的着色器命令（3.4.3）</span></span><br><span class="line">			<span class="comment">//关闭深度写入</span></span><br><span class="line">			<span class="comment">//ZWrite Off</span></span><br><span class="line">			<span class="comment">//设置透明混合命令</span></span><br><span class="line">			<span class="comment">//Blend SrcAlpha OneMinusSrcAlpha</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//CG代码片段声明						</span></span><br><span class="line">CGPROGRAM</span><br><span class="line">			<span class="comment">//定义顶点着色器与片元着色器</span></span><br><span class="line">			<span class="comment">//#pragma vertex vert</span></span><br><span class="line">			<span class="comment">//#pragma fragment frag</span></span><br><span class="line">						</span><br><span class="line">			<span class="comment">//调用unityShader内置文件，包含变量与函数</span></span><br><span class="line">			<span class="comment">//#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">//属性值获取，之前定义的属性信息存储的位置</span></span><br><span class="line">			<span class="comment">//fixed4 _Color;</span></span><br><span class="line">			<span class="comment">//sampler2D _MainTex;</span></span><br><span class="line">			<span class="comment">//float4 _MainTex_ST;</span></span><br><span class="line">						</span><br><span class="line">			<span class="comment">//输入顶点着色器结构体，根据具体需要声明，顶点，法线，纹理等信息</span></span><br><span class="line">			struct a2v &#123;</span><br><span class="line">				....</span><br><span class="line">			&#125;;</span><br><span class="line">			<span class="comment">//顶点着色器输出结构体，也是片元着色器输入结构体，神明世界空间顶点位置，法线，纹理</span></span><br><span class="line">			<span class="comment">//甚至切线空间与世界空间的变换矩阵等</span></span><br><span class="line">			struct v2f &#123;</span><br><span class="line">				....</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			v2f vert(a2v v) &#123;</span><br><span class="line">				v2f o;</span><br><span class="line">				...</span><br><span class="line">				<span class="keyword">return</span> o;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			fixed4 frag(v2f i) : SV_Target &#123;</span><br><span class="line">				...</span><br><span class="line">				<span class="comment">//返回最后的合成颜色</span></span><br><span class="line">				<span class="comment">//return ...;</span></span><br><span class="line">			&#125;</span><br><span class="line">ENDCG</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//显卡B</span></span><br><span class="line">	SubShader</span><br><span class="line">    &#123;</span><br><span class="line">		....</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//FallBack &quot;Diffuse&quot;</span></span><br><span class="line">	<span class="comment">//回调Shader，当上述Shader不运行时使用定义Shader，可填Off</span></span><br><span class="line">	FallBack &quot;VertexLit&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是Properties语义块支持的属性类型：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled3.png" alt="Untitled"></p>
<p>以下是SubShader标签中的标签类型：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled4.png" alt="Untitled"></p>
<p>以下是SubShader状态的可设置类型：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled5.png" alt="Untitled"></p>
<p>以下是Pass中的标签可设置类型：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled6.png" alt="Untitled"></p>
<p>Pass的状态可设置类型与SubShader相同+固定渲染管线命令</p>
<hr>
<h3 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h3><ul>
<li>GLSL使用文档：<a target="_blank" rel="noopener" href="http://docs.unity3d.com/Manual/SL-GLSLShaderPrograms.html">http://docs.unity3d.com/Manual/SL-GLSLShaderPrograms.html</a></li>
<li>CG语言编写教程：<a target="_blank" rel="noopener" href="https://developer.download.nvidia.cn/CgTutorial/cg_tutorial_chapter01.html">CG 教程 - 第 1 章。介绍 (nvidia.cn)</a></li>
</ul>
<hr>
<h1 id="初级部分：基础光照与基础纹理"><a href="#初级部分：基础光照与基础纹理" class="headerlink" title="初级部分：基础光照与基础纹理"></a>初级部分：基础光照与基础纹理</h1><p>了解了有关于Unity的渲染流程以及UnityShader的基本结构，那么接下来就是实际操作了，接下来的初级篇分别是第6张介绍了光照的基本原理，第7章介绍了基础的纹理效果实现，以及第8张讲述了透明效果的实现。</p>
<h2 id="基础光照"><a href="#基础光照" class="headerlink" title="基础光照"></a>基础光照</h2><p>对于了解图形学光照原理的同学，这一部分很好理解的。基础光照本身是由四个部分构成，分别是以下四个部分：</p>
<ul>
<li>自发光：<code>missive</code>，一个表面本身该向四周发射多少辐射量。如果没有使用全局光照技术，自发光的表面不会照亮周围物体，只是本身会显得更亮。直接使用材质的自发光颜色数据。</li>
<li>高光反射：<code>specular</code>，描述光线从光源照射到模型表面，该表面会以完全镜面反射散射多少辐射量。</li>
<li>漫反射：<code>diffuse</code>，描述光线从光源照射到模型表面，该表面会向每个方向散射多少辐射量。根据<code>兰伯特定律</code>：反射光线的强度与表面法线和光源方向之间的夹角的余弦值成正比。</li>
<li>环境光：<code>ambient</code>，用来描述其他所有的间接光照。使用一个全局变量来进行模拟。</li>
</ul>
<p>需要注意的，环境光与自发光都能够分别由场景中的平行光数据以及材质的数据直接获取。所以要完成基本光照在于实现漫反射与高光反射。</p>
<h3 id="漫反射"><a href="#漫反射" class="headerlink" title="漫反射"></a>漫反射</h3><p>首先是漫反射的原理主要根据兰伯特定律进行实现，是根据材质本身的颜色以及光源颜色向四周反射光线，以下是光照的计算公式，也是<code>兰伯特模型</code>：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled7.png" alt="Untitled"></p>
<p>其中n是表面法线；I是指向光源的单位矢量，Mdiffuse是材质的漫反射颜色，Clight是光源颜色。0和点乘结果取最大值，避免物体被从后方来的光源照亮。</p>
<p>除了上述的兰伯特模型之外，还有一个半兰伯特模型也用来实现漫反射效果，这是因为兰伯特模型在处理模型背光的情况下会发现模型全黑的情况（模型细节完全丢失，看过去全是黑的，没有轮廓），这是因为在上述计算中法线与光源的余弦值如果是负数，就会统一变成0来限制背光被照亮的情况。但是也导致了背光没有漫反射效果。</p>
<p>为了解决这个问题，就采用了<code>半兰伯特模型</code>来进行改进。对于法线与入射光线的余弦值的max处理修正为进行一个a倍的缩放以及一个b大小的偏移。通常情况下是0.5。这样映射范围就在[0,1]之间。</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled8.png" alt="Untitled"></p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled9.png" alt="Untitled"></p>
<p>接下来就主要是根据UnityShader的实际结构实现漫反射光照了，这里加上一个完整的Shader文件进行展示，之后如果有同样的代码内容只展示原理实现部分：</p>
<ul>
<li>漫反射效果=入射光线<em>漫反射系数</em>法线与入射光线的余弦值（具体公式上查）</li>
<li>Max函数的写法⇒函数saturate(x)，参数x是用于操作的标量或矢量，是float、float2、float3类型。能够将x截取在[0,1]范围内，如果x是矢量，就对每一个分量都进行一次该操作。</li>
</ul>
<p>以下是基于顶点着色器实现的兰伯特漫反射光照：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unity Shaders Book/Chapter <span class="number">6</span>/Diffuse Vertex-Level&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties&#123;</span><br><span class="line">        <span class="comment">//漫反射颜色</span></span><br><span class="line">        _Diffuse(&quot;Diffuse&quot;,color) = (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader&#123;</span><br><span class="line">       Pass&#123;</span><br><span class="line">            Tags&#123;&quot;LightMode&quot; = &quot;ForwardBase&quot;&#125;</span><br><span class="line"></span><br><span class="line">            CGPROGRAM</span><br><span class="line">						</span><br><span class="line">						<span class="comment">//声明顶点着色器与片元着色器</span></span><br><span class="line">            <span class="meta">#pragma vertex vert</span></span><br><span class="line">            <span class="meta">#pragma fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include&quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            fixed4 _Diffuse;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//定义输出输入结构体</span></span><br><span class="line">            struct a2v &#123;</span><br><span class="line">                float4 vertex:POSITION;</span><br><span class="line">                float3 normal:NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            struct v2f &#123;</span><br><span class="line">                float4 pos:SV_POSITION;</span><br><span class="line">                fixed3 color : COLOR;</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            v2f vert(a2v v) &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                <span class="comment">//顶点从模型空间转换到剪裁空间中；UNITY_MATRIX_MVP=&gt;模型*世界*投影矩阵</span></span><br><span class="line">                o.pos = UnityObjectToClipPos(v.vertex);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//获取环境光，UNITY_LIGHTMODEL_AMBIENT</span></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//在世界空间计算，mul，点乘，将模型顶点的法线与世界矩阵相乘，获取世界空间的顶点法线；</span></span><br><span class="line">                <span class="comment">//_World2Object 模型空间到世界空间的变换矩阵的逆矩阵，调换在mul中的位置，得到与转置矩阵相同的矩阵乘法</span></span><br><span class="line">                <span class="comment">//normalize 归一化</span></span><br><span class="line">                fixed3 worldNormal = <span class="built_in">normalize</span>(mul(v.normal, (float3x3)unity_WorldToObject));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获得环境光的光源方向</span></span><br><span class="line">                fixed3 worldLight = <span class="built_in">normalize</span>(_WorldSpaceLightPos0.xyz);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//漫反射=环境光*表面漫反射颜色*世界法线与世界入射光夹角的余弦值（小于0，则取0）</span></span><br><span class="line">                <span class="comment">//saturate 截取[0,1]</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * saturate(<span class="built_in">dot</span>(worldNormal, worldLight));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//光照效果=环境光+漫反射</span></span><br><span class="line">                o.color = ambient + diffuse;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fixed4 frag(v2f i) :SV_Target&#123;</span><br><span class="line">                <span class="keyword">return</span> fixed4(i.color,<span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    FallBack &quot;Diffuse&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上述代码可以看出，兰伯特光照的计算填写在顶点着色器中，也就是说这里实现的是逐顶点光照。但如果使用片元着色器的话能够得到更好的效果。原因在于模型的细分程度，如果是顶点数量高的高细分模型，逐渐顶点关照能够表现出良好的效果，如果是低细分模型可能会存在一些视觉问题（锯齿等）。</p>
<p>以下是逐像素兰伯特漫反射的实现：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//顶点着色器</span></span><br><span class="line"><span class="comment">//可以使用unity的内置函数</span></span><br><span class="line"><span class="comment">//负责将过顶点位置转换到投影空间</span></span><br><span class="line"><span class="comment">//将顶点法线从模型空间转换到世界空间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//片元着色器（漫反射原理实现）</span></span><br><span class="line">fixed4 frag(v2f i) : SV_Target &#123;</span><br><span class="line">	<span class="comment">//进行漫反射数据计算</span></span><br><span class="line">				</span><br><span class="line">	<span class="comment">//获取环境光数据</span></span><br><span class="line">	fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//获取世界空间的顶点法线，并归一化</span></span><br><span class="line">	fixed3 worldNormal = <span class="built_in">normalize</span>(i.worldNormal);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取世界空间的光源归一化矢量</span></span><br><span class="line">	fixed3 worldLightDir = <span class="built_in">normalize</span>(_WorldSpaceLightPos0.xyz);</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//进行漫反射模型计算</span></span><br><span class="line">	fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * saturate(<span class="built_in">dot</span>(worldNormal, worldLightDir));</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//合并环境光与漫反射光线</span></span><br><span class="line">	fixed3 color = ambient + diffuse;</span><br><span class="line">				</span><br><span class="line">	<span class="keyword">return</span> fixed4(color, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了兰伯特模型之外，这里也能够进行半兰伯特效果的实现：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">fixed4 frag(v2f i) : SV_Target &#123;</span><br><span class="line">	<span class="comment">//获取环境光数据</span></span><br><span class="line">	fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取世界空间的顶点法线，并归一化</span></span><br><span class="line">	fixed3 worldNormal = <span class="built_in">normalize</span>(i.worldNormal);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取世界空间的光源归一化矢量</span></span><br><span class="line">	fixed3 worldLightDir = <span class="built_in">normalize</span>(_WorldSpaceLightPos0.xyz);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//进行漫反射模型计算</span></span><br><span class="line">	fixed halfLambert = <span class="built_in">dot</span>(worldNormal, worldLightDir) * <span class="number">0.5</span> + <span class="number">0.5</span>;</span><br><span class="line">	fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * halfLambert;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//合并环境光与漫反射光线</span></span><br><span class="line">	fixed3 color = ambient + diffuse;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fixed4(color, <span class="number">1.0</span>);</span><br><span class="line">				</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="高光反射"><a href="#高光反射" class="headerlink" title="高光反射"></a>高光反射</h3><p>高光反射主要根据两个高光反射模型进行实现的，分别是Phone高光反射模型与Bline高光反射模型。Phone模型主要根据光源的<code>反射光线与视角方向之间的夹角</code>来确定颜色显示。而Bline高光反射模型主要是引入新的矢量h作为入射光线与视角方向的一个划分平均值，并通过他<code>与法线方向之间的夹角</code>确定颜色。如下：</p>
<ul>
<li><strong>Phone高光反射模型：</strong>  <img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled10.png" alt="Untitled"><ul>
<li>反射方向计算方法  <img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled11.png" alt="Untitled"></li>
<li>高光反射计算方法  <img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled12.png" alt="Untitled"><ul>
<li>Mglass是表面的光泽度，Mspecular是表面的高光反射颜色，控制高光反射的强度与颜色，Clight是光源的颜色与强度</li>
</ul>
</li>
</ul>
</li>
<li><strong>Bline高光反射模型</strong>  引入新的矢量h，作为入射光线l与出射光线v的一个平均值（使用时需要进行归一化变成单位矢量）  <img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled13.png" alt="Untitled"><ul>
<li>计算中间平均矢量的单位矢量  <img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled14.png" alt="Untitled"></li>
<li>高光反射计算方法  <img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled15.png" alt="Untitled"><ul>
<li>Mglass是表面的光泽度，Mspecular是表面的高光反射颜色，控制高光反射的强度与颜色，Clight是光源的颜色与强度</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>总而言之，<strong>高光反射效果</strong>=<strong>入射光线</strong><em><strong>高光反射系数</strong></em>（<strong>视角方向</strong>与<strong>反射方向</strong>的<strong>余弦值</strong>）或（<strong>视角方向</strong>与平分矢量的<strong>余弦值</strong>）的<strong>物体表面光泽度的指数方</strong>（具体公式上查）</p>
<p>以下是Phone高光反射的逐顶点光照实现：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">v2f vert(a2v v) &#123;</span><br><span class="line">	v2f o;</span><br><span class="line">	<span class="comment">//顶点：模型空间=&gt;投影空间</span></span><br><span class="line">	o.pos = UnityObjectToClipPos(v.vertex);</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//环境光</span></span><br><span class="line">	fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//法线：模型空间=&gt;世界空间</span></span><br><span class="line">	fixed3 worldNormal = <span class="built_in">normalize</span>(mul(v.normal, (float3x3)unity_WorldToObject));</span><br><span class="line">	<span class="comment">//入射方向，归一化</span></span><br><span class="line">	fixed3 worldLightDir = <span class="built_in">normalize</span>(_WorldSpaceLightPos0.xyz);</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//漫反射</span></span><br><span class="line">	fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * saturate(<span class="built_in">dot</span>(worldNormal, worldLightDir));</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//反射光线，归一化</span></span><br><span class="line">	fixed3 reflectDir = <span class="built_in">normalize</span>(<span class="built_in">reflect</span>(-worldLightDir, worldNormal));</span><br><span class="line">	<span class="comment">//视角方向，归一化</span></span><br><span class="line">	fixed3 viewDir = <span class="built_in">normalize</span>(_WorldSpaceCameraPos.xyz - mul(unity_ObjectToWorld, v.vertex).xyz);</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//获取高光反射效果</span></span><br><span class="line">	fixed3 specular = _LightColor0.rgb * _Specular.rgb * <span class="built_in">pow</span>(saturate(<span class="built_in">dot</span>(reflectDir, viewDir)), _Gloss);</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//最终效果=环境光+漫反射+高光反射</span></span><br><span class="line">	o.color = ambient + diffuse + specular;</span><br><span class="line">							 	</span><br><span class="line">	<span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是Phone高光反射的逐像素光照实现：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">fixed4 frag(v2f i) : SV_Target &#123;</span><br><span class="line">	<span class="comment">//环境光</span></span><br><span class="line">	fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//世界法线</span></span><br><span class="line">	fixed3 worldNormal = <span class="built_in">normalize</span>(i.worldNormal);</span><br><span class="line">	<span class="comment">//世界，入射光线（反向的）</span></span><br><span class="line">	fixed3 worldLightDir = <span class="built_in">normalize</span>(_WorldSpaceLightPos0.xyz);</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//漫反射效果</span></span><br><span class="line">	fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * saturate(<span class="built_in">dot</span>(worldNormal, worldLightDir));</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//反射光线归一化</span></span><br><span class="line">	fixed3 reflectDir = <span class="built_in">normalize</span>(<span class="built_in">reflect</span>(-worldLightDir, worldNormal));</span><br><span class="line">	<span class="comment">//世界空间，观察视角（摄像机-顶点位置）</span></span><br><span class="line">	fixed3 viewDir = <span class="built_in">normalize</span>(_WorldSpaceCameraPos.xyz - i.worldPos.xyz);</span><br><span class="line">	<span class="comment">//高光反射</span></span><br><span class="line">	fixed3 specular = _LightColor0.rgb * _Specular.rgb * <span class="built_in">pow</span>(saturate(<span class="built_in">dot</span>(reflectDir, viewDir)), _Gloss);</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是blinn-Phone模型高光反射的逐像素光照实现：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">fixed4 frag(v2f i) : SV_Target &#123;</span><br><span class="line">	<span class="comment">//环境光</span></span><br><span class="line">	fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//世界法线</span></span><br><span class="line">	fixed3 worldNormal = <span class="built_in">normalize</span>(i.worldNormal);</span><br><span class="line">	<span class="comment">//世界，入射光线（反向的）</span></span><br><span class="line">	fixed3 worldLightDir = <span class="built_in">normalize</span>(_WorldSpaceLightPos0.xyz);</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//漫反射效果</span></span><br><span class="line">	fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * <span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">dot</span>(worldNormal, worldLightDir));</span><br><span class="line">				</span><br><span class="line">	<span class="comment">//世界空间，观察视角</span></span><br><span class="line">	fixed3 viewDir = <span class="built_in">normalize</span>(_WorldSpaceCameraPos.xyz - i.worldPos.xyz);</span><br><span class="line">	<span class="comment">//反射夹角中线，归一化</span></span><br><span class="line">	fixed3 halfDir = <span class="built_in">normalize</span>(worldLightDir + viewDir);</span><br><span class="line">	<span class="comment">//高光反射效果</span></span><br><span class="line">	fixed3 specular = _LightColor0.rgb * _Specular.rgb * <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">dot</span>(worldNormal, halfDir)), _Gloss);</span><br><span class="line">				</span><br><span class="line">	<span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是光照效果图：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled16.png" alt="Untitled"></p>
<h3 id="Unity常用内置函数"><a href="#Unity常用内置函数" class="headerlink" title="Unity常用内置函数"></a>Unity常用内置函数</h3><p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled17.png" alt="Untitled"></p>
<hr>
<h2 id="基础纹理"><a href="#基础纹理" class="headerlink" title="基础纹理"></a>基础纹理</h2><p>Unity Shader的使用离不开纹理，所以第7章内容介绍了在unityShader中的纹理使用，分别介绍了单张纹理的使用，凹凸映射（法线）纹理的使用，渐变纹理的使用以及遮罩纹理的使用。</p>
<h3 id="单张纹理的使用"><a href="#单张纹理的使用" class="headerlink" title="单张纹理的使用"></a>单张纹理的使用</h3><p>首先是单张基础纹理的使用，首先需要定义Shader中纹理的属性，之后在Pass中声明属性存储之前定义的属性信息，设置好进出着色器的存储信息的结构体，之后再在顶点着色器中进行纹理采样即可。</p>
<p>重点在于顶点着色器中对纹理的偏移以及在片元着色器中对纹理的采样，可以使用unity内置的偏移函数<strong>TRANSFORM_TEX（纹理，偏移量）</strong>以及采样函数**tex2D(纹理,偏移UV)**。</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unity Shaders Book/Chapter <span class="number">7</span>/Single Texture&quot;&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">				<span class="comment">//定义纹理和会用到的纹理属性</span></span><br><span class="line">        <span class="comment">//颜色</span></span><br><span class="line">        _Color (&quot;Color Tint&quot;, Color) = (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">        <span class="comment">//声明一个2D纹理，内置纹理“white”，全白</span></span><br><span class="line">        _MainTex (&quot;Main Tex&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">        <span class="comment">//镜面反射（高光反射）</span></span><br><span class="line">        _Specular(&quot;Specular&quot;,Color)=(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">        <span class="comment">//光泽（材质高光反射光泽度，计算后面的那个指数）</span></span><br><span class="line">        _Gloss (&quot;Gloss&quot;, Range(<span class="number">8.0</span>,<span class="number">256</span>)) =<span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">       Pass&#123;</span><br><span class="line">            <span class="comment">//光照模式</span></span><br><span class="line">            Tags&#123;&quot;LightMode&quot;=&quot;ForwardBase&quot;&#125;</span><br><span class="line"></span><br><span class="line">            CGPROGRAM</span><br><span class="line">						</span><br><span class="line">            <span class="meta">#pragma vertex vert</span></span><br><span class="line">            <span class="meta">#pragma frafment frag</span></span><br><span class="line">            <span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//Properties中的属性描述</span></span><br><span class="line">            fixed4 _Color;</span><br><span class="line">            <span class="type">sampler2D</span> _MainTex;</span><br><span class="line">            fixed4 _Specular;</span><br><span class="line">            <span class="type">float</span> _Gloss;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//纹理属性描述，st是缩放和平移的缩写，.xy存放的是缩放值，.zw存放的是偏移值</span></span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//输出输入结构体</span></span><br><span class="line">            struct a2v &#123;</span><br><span class="line">                float4 vertex:POSITION;</span><br><span class="line">                float3 normal:NORMAL;</span><br><span class="line">                <span class="comment">//模型第一组纹理坐标</span></span><br><span class="line">                float4 texcoord:TEXCOORD0;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            struct v2f &#123;</span><br><span class="line">                float4 pos:SV_POSITION;</span><br><span class="line">                float3 worldNormal:TEXCOORD0;</span><br><span class="line">                float3 worldPos:TEXCOORD1;</span><br><span class="line">                <span class="comment">//存储纹理采样数据，对纹理坐标进行采样</span></span><br><span class="line">                float2 uv:TEXCOORD2;</span><br><span class="line">            &#125;;</span><br><span class="line">       </span><br><span class="line">            v2f vert(a2v v) &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.pos = UnityObjectToClipPos(v.vertex);</span><br><span class="line"></span><br><span class="line">                o.worldNormal = UnityObjectToWorldNormal(v.normal);</span><br><span class="line"></span><br><span class="line">                o.worldPos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//_MainTex_ST.xy 与纹理坐标相乘，进行缩放，加上_MainTex_ST.zw进行纹理偏移</span></span><br><span class="line">                o.uv = v.texcoord.xy * _MainTex_ST.xy + _MainTex_ST.zw;</span><br><span class="line">                <span class="comment">//以上过程可以直接调用TRANSFORM_TEX函数</span></span><br><span class="line">                <span class="comment">// TRANSFORM_TEX(tex,name)</span></span><br><span class="line">                <span class="comment">// tex=&gt;顶点纹理坐标，name=&gt;纹理名称</span></span><br><span class="line">                <span class="comment">//o.uv = TRANSFORM_TEX(v.texcoord, _MainTex);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//输出</span></span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fixed4 frag(v2f i) : SV_Target&#123;</span><br><span class="line">                fixed3 worldNormal = <span class="built_in">normalize</span>(i.worldNormal);</span><br><span class="line">                fixed3 worldLightDir = <span class="built_in">normalize</span>(UnityWorldSpaceLightDir(i.worldPos));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//使用纹理对漫反射颜色进行采样</span></span><br><span class="line">                fixed3 albedo = tex2D(_MainTex, i.uv).rgb * _Color.rgb;</span><br><span class="line"></span><br><span class="line">                fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz * albedo;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//漫反射</span></span><br><span class="line">                fixed3 diffuse = _LightColor0.rgb * albedo * <span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">dot</span>(worldNormal, worldLightDir));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//Bline模型</span></span><br><span class="line">                fixed3 viewDir = <span class="built_in">normalize</span>(UnityWorldSpaceViewDir(i.worldPos));</span><br><span class="line">                fixed3 halfDir = <span class="built_in">normalize</span>(worldLightDir + viewDir);</span><br><span class="line">                fixed3 specular = _LightColor0.rgb * _Specular.rgb * <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">dot</span>(worldNormal, halfDir)), _Gloss);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    FallBack &quot;Diffuse&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了上述在UnityShader脚本中编写的代码之外，材质需要绑定Shader，根据Shader中的属性设置能够绑定纹理，但同时还需要注意一下纹理的界面设置：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled18.png" alt="Untitled"></p>
<ul>
<li>Texture Type：纹理类型</li>
<li>Alpha Source：透明度选项来源（from Grayscale  来自像素灰度值生成，等等）</li>
<li>Wrap Mode：贴图模式<ul>
<li>Repeat：纹理坐标超过1，整数部分舍弃，直接使用小数部分进行采样（纹理将会不断重复）</li>
<li>Clamp：纹理坐标大于1，将会截取到1，如果小于0，将会截取到0（超出范围部分取纹理边界颜色）  <img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled19.png" alt="Untitled"></li>
</ul>
</li>
<li>Filter Mode：滤波模式，一共有三种：Point，Bilinear，Trilinear。得到的图片显示效果依次提升。以下是三种效果：<ul>
<li>Point：采样像素点数目只有一个</li>
<li>Bilinear：采用了线性滤波，每个像素目标会找周围4个邻近像素，通过线性插值混合之后最终像素。</li>
<li>Trilinear：大致与Bilinear相同，只是多了<strong>多级渐远纹理</strong>之间的相互混合。</li>
</ul>
</li>
</ul>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled20.png" alt="Untitled"></p>
<h3 id="多级渐远纹理（mipmapping）技术（有点像lod技术，⇒Levels-of-Detail）"><a href="#多级渐远纹理（mipmapping）技术（有点像lod技术，⇒Levels-of-Detail）" class="headerlink" title="多级渐远纹理（mipmapping）技术（有点像lod技术，⇒Levels of Detail）"></a>多级渐远纹理（mipmapping）技术（有点像lod技术，⇒Levels of Detail）</h3><p>将原纹理提前使用滤波处理得到更小的图像，形成图像金字塔，每一层级都是上一层级的降采样效果。（需要多余空降进行降采样纹理存储，大致多耗费33%左右的空间）是一种空间换时间的方法。</p>
<p>Unity中使用方法：Texture Type选择Advanced，勾选Generate Mip Maps 即可。以下是渲染效果：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled21.png" alt="Untitled"></p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled22.png" alt="Untitled"></p>
<ul>
<li>材质面版的选项是由shader中的属性条目进行设置的</li>
<li>MainTex：纹理的缩放与偏移量<ul>
<li>Tiling（对应代码中的MainTex.xy）:纹理缩放值</li>
<li>Offset（对应代码中的MainTex.zw）:纹理偏移值</li>
</ul>
</li>
<li>Render Queue：渲染队列，可以看一下渲染队列顺序那一篇博文（关于Unity渲染顺序）</li>
<li>Enable GPU Instancing：高效渲染大量相似物体或粒子的技术。通过合并相同材质和属性的物体或粒子，并以单个绘制调用的方式发送给GPU，从而减少了CPU与GPU之间的数据传输和渲染开销。（降低draw call的手段之一）</li>
<li>Gouble Sided Global Illumination：双面全局照明，指定光照贴图是否在计算全局光照时考虑几何体的两面。设置为 true 时，如果使用渐进光照贴图，则背面将使用与正面相同的发射和反照率来反射光。</li>
</ul>
<h3 id="凹凸映射（高度图，法线纹理）"><a href="#凹凸映射（高度图，法线纹理）" class="headerlink" title="凹凸映射（高度图，法线纹理）"></a>凹凸映射（高度图，法线纹理）</h3><p>实现凹凸映射的两种方法，但两者一般一起使用（丰富表面凹凸额外信息——光照）：</p>
<ul>
<li><strong>高度映射</strong>：使用一张<strong>高度纹理</strong>来模拟表面位移，然后得到一个修改后的法线值</li>
<li><strong>法线映射</strong>：使用一张<strong>法线纹理</strong>来存储表面法线</li>
</ul>
<p><strong><code>法线映射：</code></strong></p>
<ul>
<li>法线方向的分量范围是[-1,1]，像素的分量范围是[0,1]（以像素形式存储）。所以需要进行映射。公式如下：  $pixel=（normal+1）/2$</li>
<li>在shader中对法线纹理采样之后还需要进行一次反映射，公式如下：  $normal=pixel*2-1$</li>
</ul>
<p>Unity内置函数能够提供这部分计算。</p>
<p><strong><code>采用的法线纹理：</code></strong></p>
<p>法线是矢量，所以法线的保存通常是需要找到是哪一个空间的矢量，才有意义：</p>
<ul>
<li>模型空间的法线纹理：（以模型为中心）模型顶点自带的法线，是定义在模型空间中的，所以将修改后模型空间的表面法线存储在一张纹理中，称为模型空间的法线纹理。</li>
<li>切线空间的法线纹理（<strong>使用</strong>）：（以顶点为中心）z轴为法线方向，x轴为顶点切线方向，y轴是x轴与z轴叉乘得到的，称为副切线或副法线。如图。</li>
</ul>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled23.png" alt="Untitled"></p>
<p>模型空降存储法线优点：</p>
<ul>
<li>实现简单</li>
<li>纹理坐标的缝合处和尖锐的边角部分，突变（缝隙）减少，可以提供跟平滑的边界。</li>
</ul>
<p>切线空间存储法线优点：</p>
<ul>
<li>自由度高，模型空间下的法线信息是<strong>绝对法线信息</strong>，只能够用于创建他的模型。切线空间上的是<strong>相对法线信息</strong>，用在不用网格上能得到较为合理的结果。</li>
<li>可以进行UV动画，可以移动纹理的UV坐标实现凹凸移动的效果（水面），模型空间的法线纹理会完全错误，原因同上。</li>
<li>可以重用法线纹理，一个砖块，使用一张法线纹理就能够用到所有的6个面</li>
<li>可压缩，切线空间的法线纹理的法线的z方向总是正方向，因此能够仅存储xy，推导得到z。</li>
</ul>
<p>以下是切线空间的凹凸渲染</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">Properties &#123;</span><br><span class="line">		_Color (&quot;Color Tint&quot;, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">		<span class="comment">//纹理</span></span><br><span class="line">		_MainTex (&quot;Main Tex&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">		<span class="comment">//法线纹理“bump”是内置法线纹理</span></span><br><span class="line">		_BumpMap (&quot;Normal Map&quot;, <span class="number">2</span>D) = &quot;bump&quot; &#123;&#125;</span><br><span class="line">		<span class="comment">//用来控制凸凹程度（法线），为0时，法线不对光照造成任何影响</span></span><br><span class="line">		_BumpScale (&quot;Bump Scale&quot;, Float) = <span class="number">1.0</span></span><br><span class="line">		_Specular (&quot;Specular&quot;, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">		_Gloss (&quot;Gloss&quot;, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">		Pass &#123; </span><br><span class="line">			......</span><br><span class="line">			CGPROGRAM</span><br><span class="line">			......</span><br><span class="line"></span><br><span class="line">			<span class="comment">//属性描述</span></span><br><span class="line">			fixed4 _Color;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//主纹理与主纹理缩放偏移</span></span><br><span class="line">			<span class="type">sampler2D</span> _MainTex;</span><br><span class="line">			float4 _MainTex_ST;</span><br><span class="line">			<span class="comment">//法线纹理与法线纹理缩放偏移</span></span><br><span class="line">			<span class="type">sampler2D</span> _BumpMap;</span><br><span class="line">			float4 _BumpMap_ST;</span><br><span class="line">			<span class="comment">//用来控制凸凹程度（法线），为0时，法线不对光照造成任何影响</span></span><br><span class="line">			<span class="type">float</span> _BumpScale;</span><br><span class="line"></span><br><span class="line">			fixed4 _Specular;</span><br><span class="line">			<span class="type">float</span> _Gloss;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//顶点空间是顶点法线（已知）与切线构建出的空间，这里需要获取切线方向</span></span><br><span class="line">			struct a2v &#123;</span><br><span class="line">				float4 vertex : POSITION;</span><br><span class="line">				float3 normal : NORMAL;</span><br><span class="line">				<span class="comment">//切线方向</span></span><br><span class="line">				float4 tangent : TANGENT;</span><br><span class="line">				float4 texcoord : TEXCOORD0;</span><br><span class="line">			&#125;;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//需要在顶点着色器中计算切线空间的光照与视角</span></span><br><span class="line">			struct v2f &#123;</span><br><span class="line">				float4 pos : SV_POSITION;</span><br><span class="line">				float4 uv : TEXCOORD0;</span><br><span class="line">				float3 lightDir: TEXCOORD1;</span><br><span class="line">				float3 viewDir : TEXCOORD2;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			v2f vert(a2v v) &#123;</span><br><span class="line">				v2f o;</span><br><span class="line">				o.pos = UnityObjectToClipPos(v.vertex);</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//uv的xy分量存储第一张纹理_MainTex的纹理坐标</span></span><br><span class="line">				o.uv.xy = v.texcoord.xy * _MainTex_ST.xy + _MainTex_ST.zw;</span><br><span class="line">				<span class="comment">//uv的zw分量存储法线纹理_BumpMap的纹理坐标</span></span><br><span class="line">				o.uv.zw = v.texcoord.xy * _BumpMap_ST.xy + _BumpMap_ST.zw;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//副切线</span></span><br><span class="line">				float3 binormal = <span class="built_in">cross</span>( <span class="built_in">normalize</span>(v.normal), <span class="built_in">normalize</span>(v.tangent.xyz) ) * v.tangent.w;</span><br><span class="line">				<span class="comment">//将模型空间的切线方向、副切线方向与法线方向安行排列,得到模型空间=&gt;切线空间的变换矩阵</span></span><br><span class="line">				float3x3 rotation = float3x3(v.tangent.xyz, binormal, v.normal);</span><br><span class="line">				<span class="comment">//unity内置方法在下方，直接计算模型空间=&gt;切线空间的变换矩阵,存储到rotation</span></span><br><span class="line">				<span class="comment">//TANGENT_SPACE_ROTATION;</span></span><br><span class="line">				</span><br><span class="line">				<span class="comment">//获取切线空间的光源</span></span><br><span class="line">				o.lightDir = mul(rotation, <span class="built_in">normalize</span>(ObjSpaceLightDir(v.vertex))).xyz;</span><br><span class="line">				<span class="comment">//获取切线空间的视角</span></span><br><span class="line">				o.viewDir = mul(rotation, <span class="built_in">normalize</span>(ObjSpaceViewDir(v.vertex))).xyz;</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">return</span> o;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			fixed4 frag(v2f i) : SV_Target &#123;</span><br><span class="line">				<span class="comment">//切线空间的光源方向与视角方向矢量归一化</span></span><br><span class="line">				fixed3 tangentLightDir = <span class="built_in">normalize</span>(i.lightDir);</span><br><span class="line">				fixed3 tangentViewDir = <span class="built_in">normalize</span>(i.viewDir);</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//进行法线纹理采样</span></span><br><span class="line">				fixed4 packedNormal = tex2D(_BumpMap, i.uv.zw);</span><br><span class="line">				fixed3 tangentNormal;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//法线纹理存储的是法线经过映射之后的像素值。需要将其反映射回来</span></span><br><span class="line">				<span class="comment">// 如果unity中没有设置法线纹理为Normal map类型，就需要在代码中进行反映射</span></span><br><span class="line">				<span class="comment">//tangentNormal.xy = (packedNormal.xy * 2 - 1) * _BumpScale;</span></span><br><span class="line">				<span class="comment">//tangentNormal.z = sqrt(1.0 - saturate(dot(tangentNormal.xy, tangentNormal.xy)));</span></span><br><span class="line">				<span class="comment">//unity内置方法</span></span><br><span class="line">				tangentNormal = UnpackNormal(packedNormal);</span><br><span class="line">				tangentNormal.xy *= _BumpScale;</span><br><span class="line">				<span class="comment">//切线空间的法线z分量，由xy分量获得</span></span><br><span class="line">				<span class="comment">//saturate函数限制数值范围在[0,1]中</span></span><br><span class="line">				tangentNormal.z = <span class="built_in">sqrt</span>(<span class="number">1.0</span> - saturate(<span class="built_in">dot</span>(tangentNormal.xy, tangentNormal.xy)));</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//使用纹理对漫反射颜色进行采样</span></span><br><span class="line">				fixed3 albedo = tex2D(_MainTex, i.uv).rgb * _Color.rgb;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//环境光</span></span><br><span class="line">				fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz * albedo;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//漫反射</span></span><br><span class="line">				fixed3 diffuse = _LightColor0.rgb * albedo * <span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">dot</span>(tangentNormal, tangentLightDir));</span><br><span class="line"></span><br><span class="line">				<span class="comment">//高光反射，blinn模型</span></span><br><span class="line">				fixed3 halfDir = <span class="built_in">normalize</span>(tangentLightDir + tangentViewDir);</span><br><span class="line">				fixed3 specular = _LightColor0.rgb * _Specular.rgb * <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">dot</span>(tangentNormal, halfDir)), _Gloss);</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			ENDCG</span><br><span class="line">		&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以下是世界空间的凹凸渲染</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//凹凸，世界空间——法线纹理</span></span><br><span class="line">Shader &quot;Unity Shaders Book/Chapter <span class="number">7</span>/Normal Map In World Space&quot; &#123;</span><br><span class="line">	Properties &#123;</span><br><span class="line">		_Color (&quot;Color Tint&quot;, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//贴图与法线贴图以及法线凹凸系数</span></span><br><span class="line">		_MainTex (&quot;Main Tex&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">		_BumpMap (&quot;Normal Map&quot;, <span class="number">2</span>D) = &quot;bump&quot; &#123;&#125;</span><br><span class="line">		_BumpScale (&quot;Bump Scale&quot;, Float) = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">		_Specular (&quot;Specular&quot;, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">		_Gloss (&quot;Gloss&quot;, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">	&#125;</span><br><span class="line">	SubShader &#123;</span><br><span class="line">		Pass &#123; </span><br><span class="line">			Tags &#123; &quot;LightMode&quot;=&quot;ForwardBase&quot; &#125;</span><br><span class="line">		</span><br><span class="line">			CGPROGRAM</span><br><span class="line">			</span><br><span class="line">			<span class="meta">#pragma vertex vert</span></span><br><span class="line">			<span class="meta">#pragma fragment frag</span></span><br><span class="line">			</span><br><span class="line">			<span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line">			</span><br><span class="line">			fixed4 _Color;</span><br><span class="line"></span><br><span class="line">			<span class="type">sampler2D</span> _MainTex;</span><br><span class="line">			float4 _MainTex_ST;</span><br><span class="line"></span><br><span class="line">			<span class="type">sampler2D</span> _BumpMap;</span><br><span class="line">			float4 _BumpMap_ST;</span><br><span class="line">			<span class="type">float</span> _BumpScale;</span><br><span class="line"></span><br><span class="line">			fixed4 _Specular;</span><br><span class="line">			<span class="type">float</span> _Gloss;</span><br><span class="line">			</span><br><span class="line">			struct a2v &#123;</span><br><span class="line">				float4 vertex : POSITION;</span><br><span class="line">				float3 normal : NORMAL;</span><br><span class="line">				float4 tangent : TANGENT;</span><br><span class="line">				float4 texcoord : TEXCOORD0;</span><br><span class="line">			&#125;;</span><br><span class="line">			</span><br><span class="line">			struct v2f &#123;</span><br><span class="line">				float4 pos : SV_POSITION;</span><br><span class="line">				float4 uv : TEXCOORD0;</span><br><span class="line">				<span class="comment">//注意这里计算的是世界空间的凹凸纹理</span></span><br><span class="line">				<span class="comment">//这里是存储了切线空间到世界空间的转换矩阵</span></span><br><span class="line">				float4 TtoW0 : TEXCOORD1;  </span><br><span class="line">				float4 TtoW1 : TEXCOORD2;  </span><br><span class="line">				float4 TtoW2 : TEXCOORD3;*</span><br><span class="line">			&#125;;</span><br><span class="line">			</span><br><span class="line">			v2f vert(a2v v) &#123;</span><br><span class="line">				v2f o;</span><br><span class="line">				o.pos = UnityObjectToClipPos(v.vertex);</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//对纹理坐标进行缩放与平移</span></span><br><span class="line">				o.uv.xy = v.texcoord.xy * _MainTex_ST.xy + _MainTex_ST.zw;</span><br><span class="line">				o.uv.zw = v.texcoord.xy * _BumpMap_ST.xy + _BumpMap_ST.zw;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//世界空间顶点</span></span><br><span class="line">				float3 worldPos = mul(unity_ObjectToWorld, v.vertex).xyz;  </span><br><span class="line">				<span class="comment">//世界空间法线</span></span><br><span class="line">				fixed3 worldNormal = UnityObjectToWorldNormal(v.normal);  </span><br><span class="line">				<span class="comment">//世界空间切线</span></span><br><span class="line">				fixed3 worldTangent = UnityObjectToWorldDir(v.tangent.xyz);</span><br><span class="line">				<span class="comment">//世界空间副切线</span></span><br><span class="line">				fixed3 worldBinormal = <span class="built_in">cross</span>(worldNormal, worldTangent) * v.tangent.w;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 摆放世界空间法线，世界空间切线，世界空间副切线得到切线空间到设计空间的变换矩阵</span></span><br><span class="line">				<span class="comment">// 保存世界空间顶点xyz（利用存储空间，保存世界空间坐标）</span></span><br><span class="line">				o.TtoW0 = float4(worldTangent.x, worldBinormal.x, worldNormal.x, worldPos.x);</span><br><span class="line">				o.TtoW1 = float4(worldTangent.y, worldBinormal.y, worldNormal.y, worldPos.y);</span><br><span class="line">				o.TtoW2 = float4(worldTangent.z, worldBinormal.z, worldNormal.z, worldPos.z);**</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">return</span> o;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			fixed4 frag(v2f i) : SV_Target &#123;</span><br><span class="line">				<span class="comment">// 获取世界空间顶点坐标	</span></span><br><span class="line">				float3 worldPos = float3(i.TtoW0.w, i.TtoW1.w, i.TtoW2.w);</span><br><span class="line">				<span class="comment">// 获取世界空间光源与视角</span></span><br><span class="line">				fixed3 lightDir = <span class="built_in">normalize</span>(UnityWorldSpaceLightDir(worldPos));</span><br><span class="line">				fixed3 viewDir = <span class="built_in">normalize</span>(UnityWorldSpaceViewDir(worldPos));</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 获取切线空间的法线，使用UnpackNormal进行法线贴图采样与解码（将法线纹理标格式识成Normal map）</span></span><br><span class="line">				fixed3 bump = UnpackNormal(tex2D(_BumpMap, i.uv.zw));</span><br><span class="line">				<span class="comment">//通过_BumpScale对法线进行缩放</span></span><br><span class="line">				bump.xy *= _BumpScale;</span><br><span class="line">				bump.z = <span class="built_in">sqrt</span>(<span class="number">1.0</span> - saturate(<span class="built_in">dot</span>(bump.xy, bump.xy)));</span><br><span class="line"></span><br><span class="line">				<span class="comment">//将法线从切线空间转换到世界空间</span></span><br><span class="line">				bump = <span class="built_in">normalize</span>(half3(<span class="built_in">dot</span>(i.TtoW0.xyz, bump), <span class="built_in">dot</span>(i.TtoW1.xyz, bump), <span class="built_in">dot</span>(i.TtoW2.xyz, bump)));</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//纹理材质采样</span></span><br><span class="line">				fixed3 albedo = tex2D(_MainTex, i.uv).rgb * _Color.rgb;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//环境光</span></span><br><span class="line">				fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz * albedo;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//漫反射</span></span><br><span class="line">				fixed3 diffuse = _LightColor0.rgb * albedo * <span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">dot</span>(bump, lightDir));</span><br><span class="line"></span><br><span class="line">				fixed3 halfDir = <span class="built_in">normalize</span>(lightDir + viewDir);</span><br><span class="line">				fixed3 specular = _LightColor0.rgb * _Specular.rgb * <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">dot</span>(bump, halfDir)), _Gloss);</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			ENDCG</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	FallBack &quot;Specular&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注意，如果使用UnpackNormal函数来进行法线贴图的法线获取。需要将法线贴图设置成Normal map类型。这是因为设置成Normal map类型后，unity会根据不同平台对纹理进行压缩（如DZT5nm格式会省略z轴，通过xy轴求）。之后在通过UnpackNormal解压缩并获取正确的法线。</li>
</ul>
<h3 id="渐变纹理"><a href="#渐变纹理" class="headerlink" title="渐变纹理"></a>渐变纹理</h3><ul>
<li>一种冷到暖色调的着色技术（插画风格的渲染效果）</li>
</ul>
<p>以下是三种渐变纹理的区别：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled24.png" alt="Untitled"></p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//渐变纹理</span></span><br><span class="line">Shader &quot;Unity Shaders Book/Chapter <span class="number">7</span>/Ramp Texture&quot; &#123;</span><br><span class="line">	Properties &#123;</span><br><span class="line">		_Color (&quot;Color Tint&quot;, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">		**<span class="comment">//渐变纹理</span></span><br><span class="line">		_RampTex (&quot;Ramp Tex&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;**</span><br><span class="line">		_Specular (&quot;Specular&quot;, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">		_Gloss (&quot;Gloss&quot;, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">	&#125;</span><br><span class="line">	SubShader &#123;</span><br><span class="line">		Pass &#123; </span><br><span class="line">			Tags &#123; &quot;LightMode&quot;=&quot;ForwardBase&quot; &#125;</span><br><span class="line">		</span><br><span class="line">			CGPROGRAM</span><br><span class="line">			</span><br><span class="line">			<span class="meta">#pragma vertex vert</span></span><br><span class="line">			<span class="meta">#pragma fragment frag</span></span><br><span class="line"></span><br><span class="line">			<span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line">			</span><br><span class="line">			fixed4 _Color;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//定义渐变纹理与渐变纹理缩放平移</span></span><br><span class="line">			<span class="type">sampler2D</span> _RampTex;</span><br><span class="line">			float4 _RampTex_ST;</span><br><span class="line"></span><br><span class="line">			fixed4 _Specular;</span><br><span class="line">			<span class="type">float</span> _Gloss;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//顶点着色器数据输入</span></span><br><span class="line">			struct a2v &#123;</span><br><span class="line">				float4 vertex : POSITION;</span><br><span class="line">				float3 normal : NORMAL;</span><br><span class="line">				<span class="comment">//第一组纹理（输入的纹理）</span></span><br><span class="line">				float4 texcoord : TEXCOORD0;</span><br><span class="line">			&#125;;</span><br><span class="line">			</span><br><span class="line">			struct v2f &#123;</span><br><span class="line">				<span class="comment">//投影空间顶点</span></span><br><span class="line">				float4 pos : SV_POSITION;</span><br><span class="line">				float3 worldNormal : TEXCOORD0;</span><br><span class="line">				float3 worldPos : TEXCOORD1;</span><br><span class="line">				float2 uv : TEXCOORD2;</span><br><span class="line">			&#125;;</span><br><span class="line">			</span><br><span class="line">			v2f vert(a2v v) &#123;</span><br><span class="line">				v2f o;</span><br><span class="line">				o.pos = UnityObjectToClipPos(v.vertex);</span><br><span class="line">				</span><br><span class="line">				o.worldNormal = UnityObjectToWorldNormal(v.normal);</span><br><span class="line">				</span><br><span class="line">				o.worldPos = mul(unity_ObjectToWorld, v.vertex).xyz;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//TRANSFORM_TEX,计算平铺与平移之后的纹理坐标</span></span><br><span class="line">				o.uv = TRANSFORM_TEX(v.texcoord, _RampTex);</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">return</span> o;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			fixed4 frag(v2f i) : SV_Target &#123;</span><br><span class="line">				fixed3 worldNormal = <span class="built_in">normalize</span>(i.worldNormal);</span><br><span class="line">				<span class="comment">//获得世界空间光源</span></span><br><span class="line">				fixed3 worldLightDir = <span class="built_in">normalize</span>(UnityWorldSpaceLightDir(i.worldPos));</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//环境光</span></span><br><span class="line">				fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 半兰伯特模型（控制显示范围）</span></span><br><span class="line">				fixed halfLambert  = <span class="number">0.5</span> * <span class="built_in">dot</span>(worldNormal, worldLightDir) + <span class="number">0.5</span>;</span><br><span class="line">				<span class="comment">//获取漫反射颜色（通过纹理采样获取）</span></span><br><span class="line">				fixed3 diffuseColor = tex2D(_RampTex, fixed2(halfLambert, halfLambert)).rgb * _Color.rgb;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//_LightColor0顶点光源强度与漫反射强度得到漫反射效果</span></span><br><span class="line">				fixed3 diffuse = _LightColor0.rgb * diffuseColor;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//高光反射，blinn模型</span></span><br><span class="line">				fixed3 viewDir = <span class="built_in">normalize</span>(UnityWorldSpaceViewDir(i.worldPos));</span><br><span class="line">				fixed3 halfDir = <span class="built_in">normalize</span>(worldLightDir + viewDir);</span><br><span class="line">				fixed3 specular = _LightColor0.rgb * _Specular.rgb * <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">dot</span>(worldNormal, halfDir)), _Gloss);</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			ENDCG</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	FallBack &quot;Specular&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在片元着色器中使用半兰伯特模型对法线方向与光照方向的点积进行一次半兰伯特计算，映射了显示范围。<ul>
<li>个人推测，避免兰伯特光照造成的背光模型无变化（不符合渐变纹理显示效果），所以使用半兰伯特模型</li>
</ul>
</li>
<li>由_RampTex纹理图片可以看出，这是一个横轴颜色逐渐变化，重轴颜色相同的纹理。所以使用半兰伯特部分构建一维纹理坐标，对_RampTex纹理进行采样。（fixed2(halfLambert, halfLambert)）</li>
<li>需要注意：进行纹理采样的时候，需要将渐变纹理的Wrap Mode模式设置成Clamp模式，防止纹理采样由于浮点数精度造成的问题。</li>
</ul>
<h3 id="遮罩纹理"><a href="#遮罩纹理" class="headerlink" title="遮罩纹理"></a>遮罩纹理</h3><ul>
<li>用来控制部分区域不同于其他区域的显示效果</li>
<li>遮罩纹理流程：通过采样获取遮罩纹理的值，使用其中某个（或某几个）通道的值与某种表面属性相乘（改通道值为0时，表面不受该属性影响）</li>
</ul>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade <span class="doctag">NOTE:</span> replaced &#x27;mul(UNITY_MATRIX_MVP,*)&#x27; with &#x27;UnityObjectToClipPos(*)&#x27;</span></span><br><span class="line"><span class="comment">//遮罩纹理</span></span><br><span class="line">Shader &quot;Unity Shaders Book/Chapter <span class="number">7</span>/Mask Texture&quot; &#123;</span><br><span class="line">	Properties &#123;</span><br><span class="line">		_Color (&quot;Color Tint&quot;, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">		<span class="comment">//主纹理</span></span><br><span class="line">		_MainTex (&quot;Main Tex&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">		<span class="comment">//法线纹理与法线凹凸缩放</span></span><br><span class="line">		_BumpMap (&quot;Normal Map&quot;, <span class="number">2</span>D) = &quot;bump&quot; &#123;&#125;</span><br><span class="line">		_BumpScale(&quot;Bump Scale&quot;, Float) = <span class="number">1.0</span></span><br><span class="line">		<span class="comment">//遮罩纹理与遮罩缩放</span></span><br><span class="line">		_SpecularMask (&quot;Specular Mask&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">		_SpecularScale (&quot;Specular Scale&quot;, Float) = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">		_Specular (&quot;Specular&quot;, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">		_Gloss (&quot;Gloss&quot;, Range(<span class="number">8.0</span>, <span class="number">256</span>)) = <span class="number">20</span></span><br><span class="line">	&#125;</span><br><span class="line">	SubShader &#123;</span><br><span class="line">		Pass &#123; </span><br><span class="line">			Tags &#123; &quot;LightMode&quot;=&quot;ForwardBase&quot; &#125;</span><br><span class="line">		</span><br><span class="line">			CGPROGRAM</span><br><span class="line">			</span><br><span class="line">			<span class="meta">#pragma vertex vert</span></span><br><span class="line">			<span class="meta">#pragma fragment frag</span></span><br><span class="line">			</span><br><span class="line">			<span class="meta">#include &quot;Lighting.cginc&quot;</span></span><br><span class="line">			</span><br><span class="line">			fixed4 _Color;</span><br><span class="line">			<span class="comment">//主纹理与纹理缩放</span></span><br><span class="line">			<span class="type">sampler2D</span> _MainTex;</span><br><span class="line">			float4 _MainTex_ST;</span><br><span class="line">			<span class="comment">//法线纹理与纹理缩放</span></span><br><span class="line">			<span class="type">sampler2D</span> _BumpMap;</span><br><span class="line">			<span class="type">float</span> _BumpScale;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//遮罩纹理与缩放（是用来控制高光反射效果的）</span></span><br><span class="line">			<span class="type">sampler2D</span> _SpecularMask;</span><br><span class="line">			<span class="type">float</span> _SpecularScale;**</span><br><span class="line"></span><br><span class="line">			fixed4 _Specular;</span><br><span class="line">			<span class="type">float</span> _Gloss;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//顶点着色器输入：模型空间顶点、法线、切线、第一张纹理</span></span><br><span class="line">			struct a2v &#123;</span><br><span class="line">				float4 vertex : POSITION;</span><br><span class="line">				float3 normal : NORMAL;</span><br><span class="line">				float4 tangent : TANGENT;</span><br><span class="line">				float4 texcoord : TEXCOORD0;</span><br><span class="line">			&#125;;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//顶点输出与片元着色器输入：顶点位置、uv纹理、光源、视角</span></span><br><span class="line">			struct v2f &#123;</span><br><span class="line">				<span class="comment">//剪裁空间</span></span><br><span class="line">				float4 pos : SV_POSITION;</span><br><span class="line">				float2 uv : TEXCOORD0;</span><br><span class="line">				<span class="comment">//切线空间</span></span><br><span class="line">				float3 lightDir: TEXCOORD1;</span><br><span class="line">				float3 viewDir : TEXCOORD2;</span><br><span class="line">			&#125;;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//顶点着色器</span></span><br><span class="line">			v2f vert(a2v v) &#123;</span><br><span class="line">				v2f o;</span><br><span class="line">				<span class="comment">//模型空间顶点=&gt;剪裁空间顶点</span></span><br><span class="line">				o.pos = UnityObjectToClipPos(v.vertex);</span><br><span class="line">				<span class="comment">//对第一张纹理进行采样（缩放平移）</span></span><br><span class="line">				o.uv.xy = v.texcoord.xy * _MainTex_ST.xy + _MainTex_ST.zw;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//unity内置方法，直接计算模型空间=&gt;切线空间的变换矩阵,存储到rotation</span></span><br><span class="line">				TANGENT_SPACE_ROTATION;</span><br><span class="line">				<span class="comment">//获得切线空间的光源与视角</span></span><br><span class="line">				o.lightDir = mul(rotation, ObjSpaceLightDir(v.vertex)).xyz;</span><br><span class="line">				o.viewDir = mul(rotation, ObjSpaceViewDir(v.vertex)).xyz;</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">return</span> o;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			fixed4 frag(v2f i) : SV_Target &#123;</span><br><span class="line">				<span class="comment">//切线空间光源视角归一化</span></span><br><span class="line">			 	fixed3 tangentLightDir = <span class="built_in">normalize</span>(i.lightDir);</span><br><span class="line">				fixed3 tangentViewDir = <span class="built_in">normalize</span>(i.viewDir);</span><br><span class="line"></span><br><span class="line">				<span class="comment">//获得切线空间法线，纹理采样与解码</span></span><br><span class="line">				fixed3 tangentNormal = UnpackNormal(tex2D(_BumpMap, i.uv));</span><br><span class="line">				tangentNormal.xy *= _BumpScale;</span><br><span class="line">				tangentNormal.z = <span class="built_in">sqrt</span>(<span class="number">1.0</span> - saturate(<span class="built_in">dot</span>(tangentNormal.xy, tangentNormal.xy)));</span><br><span class="line"></span><br><span class="line">				<span class="comment">//主纹理材质采样</span></span><br><span class="line">				fixed3 albedo = tex2D(_MainTex, i.uv).rgb * _Color.rgb;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//环境光</span></span><br><span class="line">				fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz * albedo;</span><br><span class="line">				<span class="comment">//漫反射</span></span><br><span class="line">				fixed3 diffuse = _LightColor0.rgb * albedo * <span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">dot</span>(tangentNormal, tangentLightDir));</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//blinn模型，视角与入射光源的平分线</span></span><br><span class="line">			 	fixed3 halfDir = <span class="built_in">normalize</span>(tangentLightDir + tangentViewDir);</span><br><span class="line">			 	</span><br><span class="line">				<span class="comment">//遮罩纹理采样（本纹理，三个通道数值相同步，rgb三个通道只使用了r通道）</span></span><br><span class="line">			 	fixed specularMask = tex2D(_SpecularMask, i.uv).r * _SpecularScale;</span><br><span class="line">			 	</span><br><span class="line">				<span class="comment">//高光反射——高光反射结果乘以遮罩纹理采样数据</span></span><br><span class="line">			 	fixed3 specular = _LightColor0.rgb * _Specular.rgb * <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">dot</span>(tangentNormal, halfDir)), _Gloss) * specularMask;</span><br><span class="line">			</span><br><span class="line">				<span class="keyword">return</span> fixed4(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			ENDCG</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	FallBack &quot;Specular&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是效果对比：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled25.png" alt="Untitled"></p>
<hr>
<h2 id="透明测试、混合与面剔除"><a href="#透明测试、混合与面剔除" class="headerlink" title="透明测试、混合与面剔除"></a>透明测试、混合与面剔除</h2><p>透明效果是游戏中最常见的效果之一。在unity中，实现透明效果有2种方式，分别是完全透明的透明度测试以及会混合前后颜色，实现半透明效果的透明度混合。透明度测试相对简单，这也是因为透明度测试实现的是完全透明效果，不用关闭深度写入，效果极端；而透明度混合则相对复杂，主要原因还是因为关闭了深度写入，导致的一些由于渲染顺序或物体相互之间的层级引起的一些问题。所以首先我们要先来了解一下深度写入与渲染顺序的概念。</p>
<h3 id="深度写入与渲染顺序"><a href="#深度写入与渲染顺序" class="headerlink" title="深度写入与渲染顺序"></a>深度写入与渲染顺序</h3><p>深度写入：用于判断物体遮挡情况下需要渲染的颜色。将深度数值写入深度缓冲区，在深度测试的时候，在颜色缓冲区将深度小的像素的颜色替换深度大的物体的深度颜色。这样就能够渲染出离摄像机更近的物体颜色。</p>
<ul>
<li>关闭<strong>深度写入</strong>：需要注意的是，透明度混合是由<code>透明物体的颜色</code>以及<code>透明物体之后的物体颜色</code>组合成的。其中透明物体之后的物体颜色存储在存储在颜色缓冲区。如果不关闭深度写入，在进行深度测试的时候，之后的物体由于深度更大，会因为深度写入将原本存储在颜色缓冲区的物体表面颜色数值剔除掉。就无法进行透明度混合了。（之后的物体颜色丢失）<ul>
<li>简单来说，两个物体如果都有深度值，就会进行深度检测，导致颜色缓冲区的颜色被替代。</li>
<li>关闭深度写入，颜色缓冲区就有之后物体的颜色，与当前半透明物体的颜色混合，就有了混合效果的颜色。</li>
</ul>
</li>
<li>渲染顺序：由于关闭了深度写入，所以无法判断物体里摄像机远近，所以渲染时需要注意物体的渲染顺序，先渲染不透明物体，在渲染半透明物体。以下是个渲染效果说明：<ul>
<li>存在半透明物体A，在前；不透明物体B，在后。（都为半透明也同理）</li>
<li>正确渲染效果：先渲染物体B，再渲染物体A。不透明物体B开启了深度测试与深度写入，此时深度缓冲区没有数值，B将自己的深度写入深度缓冲区，颜色写入颜色缓冲区。再渲染半透明物体A，由于物体A关闭深度写入，只有深度检测。深度检测物体A里摄像机更近，读取颜色缓冲区B的颜色，与物体A颜色混合，达成半透明效果。</li>
<li>错误渲染效果：先渲染物体A，再渲染物体B。半透明物体A只开启了深度测试，没有深度写入，此时深度缓冲区没有数值也不写入，A将自己的颜色写入颜色缓冲区。再渲染不透明物体B，由于B开启了深度检测与深度写入。同时发现深度缓冲区内没有深度值，B会直接修改颜色缓冲区中的颜色（为B的颜色），A的颜色被覆盖丢失，最后屏幕上渲染出B的颜色（看起来B在A之前，也就是没有混合，只有B的颜色）。</li>
</ul>
</li>
</ul>
<p>至于Unity的渲染顺序，有需要的可以参考<a target="_blank" rel="noopener" href="https://the-black-sun.github.io/2023/09/05/Unity%E6%B8%B2%E6%9F%93%E9%A1%BA%E5%BA%8F%E6%8E%A2%E7%A9%B6/">Unity渲染顺序探究 | 墨墨辰的旋转小屋 (the-black-sun.github.io)</a>的简要说明。需要注意的是：</p>
<ul>
<li>先渲染所有不透明物体，并开启深度测试与深度写入</li>
<li>将半透明物体安距离摄像机远近排序，然后从后往前渲染，并开启深度测试，关闭深度写入</li>
</ul>
<h3 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h3><p>虽然有深度测试与渲染顺序的调整存在，但是仍然存在一个问题：单个重叠物体或多个相互重叠物体会导致混合效果错误。存在物体相互堆叠的情况，存在物体的部分区域的渲染前后排序顺序不一致的情况，但是调整渲染顺序无法解决这一个问题。因为根据深度进行渲染顺序调整是以物体为单位进行的，而深度测试与深度写入是以像素点为单位进行的。面对这种情况，UnityShader通常使用两个Pass进行解决（一个进行混合操作，一个进行深度写入，注意关闭深度写入的相关操作也在Pass中进行）。</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled26.png" alt="Untitled"></p>
<h3 id="UnityShader的渲染队列"><a href="#UnityShader的渲染队列" class="headerlink" title="UnityShader的渲染队列"></a>UnityShader的渲染队列</h3><p>上述由于物体堆叠导致的渲染顺序问题，Unity通过渲染队列来进行解决。SubShader的<code>Queue</code>标签可以决定模型改归于哪一个渲染队列，索引号越小表示越早被渲染。渲染队列有以下几种：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>队列索引号(RenderQueue)</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Background</td>
<td>1000</td>
<td>该队列在其他所有队列之前被渲染，通常用来渲染需要被绘制在背景上的物体</td>
</tr>
<tr>
<td>Geometry</td>
<td>2000</td>
<td>默认渲染队列，大多数物体使用的队列，不透明物体使用的队列</td>
</tr>
<tr>
<td>AlphaTest</td>
<td>2450（小于2500为完全不透明）</td>
<td>需要进行透明度测试的物体使用的队列。</td>
</tr>
<tr>
<td>Transparent</td>
<td>3000</td>
<td>该队列中的物体会在前两个队列（Geometry与AlphaTest）渲染之后，再根据从后往前的顺序进行渲染，所有使用了透明度混合的物体使用该队列。</td>
</tr>
<tr>
<td>Overlay</td>
<td>4000</td>
<td>该队列用来实现叠加效果，需要在最后渲染的物体使用这个队列</td>
</tr>
</tbody></table>
<p>以下是UnityShader中的渲染队列设置：</p>
<ul>
<li>透明度测试  <figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SubShader&#123;</span><br><span class="line">	Tags&#123;&quot;Queue&quot;=&quot;AlphaTest&quot;&#125;</span><br><span class="line">	Pass&#123;</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>透明度混合  <figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SubShader&#123;</span><br><span class="line">	Tags&#123;&quot;Queue&quot;=&quot;Transparent&quot;&#125;</span><br><span class="line">	Pass&#123;</span><br><span class="line">		ZWrite Off</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>接下来来看一下透明度测试与透明度混合的具体效果实现。</p>
<h3 id="透明度测试"><a href="#透明度测试" class="headerlink" title="透明度测试"></a>透明度测试</h3><p>实现的是完全透明或完全不透明效果。需要用到一个由CG提供的透明度测试函数clip，如下所示：</p>
<ul>
<li>函数：void clip(float<strong>X</strong>  x)⇒<code>X代表数字无~4</code></li>
<li>参数：剪裁时使用的标量或矢量条件</li>
<li>描述：如果给定参数的任何一个分量是负数，就会舍弃当前像素的输出颜色</li>
</ul>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> clip(float4 x)&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">any</span>(x&lt;<span class="number">0</span>))</span><br><span class="line">		<span class="keyword">discard</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是透明度测试的部分代码：没有通过透明度测试的像素直接舍弃掉（discard）。</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unity Shaders Book/Chapter <span class="number">8</span>/Alpha Test&quot; &#123;</span><br><span class="line">	Properties &#123;</span><br><span class="line">		<span class="comment">//颜色与纹理等属性</span></span><br><span class="line">		....</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//像素透明度参数</span></span><br><span class="line">		_Cutoff (&quot;Alpha Cutoff&quot;, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0.5</span></span><br><span class="line">	&#125;</span><br><span class="line">	SubShader &#123;</span><br><span class="line">		<span class="comment">//Queue设置为透明度测试；</span></span><br><span class="line">		<span class="comment">//IgnoreProjector设置为true，不收到投影器影响；</span></span><br><span class="line">		<span class="comment">//RenderType类型，该shader加入Transparent组</span></span><br><span class="line">		Tags &#123;&quot;Queue&quot;=&quot;AlphaTest&quot; &quot;IgnoreProjector&quot;=&quot;True&quot; &quot;RenderType&quot;=&quot;TransparentCutout&quot;&#125;</span><br><span class="line">		</span><br><span class="line">		Pass &#123;</span><br><span class="line">			....</span><br><span class="line">			<span class="comment">//透明度参数</span></span><br><span class="line">			fixed _Cutoff;</span><br><span class="line">			....</span><br><span class="line">			</span><br><span class="line">			fixed4 frag(v2f i) : SV_Target &#123;</span><br><span class="line">				....</span><br><span class="line"></span><br><span class="line">				<span class="comment">//纹理采样与解码</span></span><br><span class="line">				fixed4 texColor = tex2D(_MainTex, i.uv);</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// Alpha test  开启透明度测试</span></span><br><span class="line">				clip (texColor.a - _Cutoff);</span><br><span class="line">				<span class="comment">// Equal to </span></span><br><span class="line">				<span class="comment">// if ((texColor.a - _Cutoff) &lt; 0.0) &#123;</span></span><br><span class="line">				<span class="comment">//discard;</span></span><br><span class="line">				<span class="comment">//&#125;</span></span><br><span class="line">				</span><br><span class="line">				....</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			....</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	FallBack &quot;Transparent/Cutout/VertexLit&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="透明度混合"><a href="#透明度混合" class="headerlink" title="透明度混合"></a>透明度混合</h3><p>透明度混合能够实现真正的半透明效果。透明度混合需要通过Blend命令进行逐片元透明混合设置，主要的Blend命令如下：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled27.png" alt="Untitled"></p>
<p>由上图可以看出第2种和第3种命令存在着混合因子这个概念，这个混合因子是为了控制两种颜色的混合比例而产生的。其中第2种混合命令，提供两个混合因子用来控制两个混合颜色的混合比例，RGB与A通道的混合因子相同；第3种提供了四个混合因子，多出来的两个分别用来里控制两种颜色的透明度通道，RGB与A通道的混合因子不同。</p>
<p>同时以下是SubShader中支持的混合因子：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled28.png" alt="Untitled"></p>
<p>除此之外还有SubShader支持的混合操作（前后两种颜色混合方式）以及常见的混合类型，通过<code>BlendOp命令</code>进行修改：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Add</td>
<td>将混合后的源颜色与混合后的目的颜色相加。是默认的混合操作，等式如下：O=SrcFactor<em>S+DstFactor</em>D</td>
</tr>
<tr>
<td>Sub</td>
<td>将混合后的源颜色减去混合后的目的颜色。O=SrcFactor<em>S-DstFactor</em>D</td>
</tr>
<tr>
<td>RevSub</td>
<td>将混合后的目的颜色减去混合后的源颜色。O=DstFactor<em>D-SrcFactor</em>S</td>
</tr>
<tr>
<td>Min</td>
<td>使用源颜色和目的颜色中较小的值，每个分量都进行比较。</td>
</tr>
<tr>
<td>Max</td>
<td>使用源颜色和目的颜色中较大的值，每个分量都进行比较。</td>
</tr>
<tr>
<td>其他逻辑操作</td>
<td>仅仅DX11支持</td>
</tr>
</tbody></table>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注意指令格式,SrcFactor、DstFactor以及SrcFactorA和DstFactorA都能用以上混合因子表中的值代替，如下</span></span><br><span class="line">Blend SrcFactor DstFactor</span><br><span class="line">Blend SrcFactor DstFactor,SrcFactorA DstFactorA</span><br><span class="line"></span><br><span class="line"><span class="comment">//正常（Normal），透明度混合</span></span><br><span class="line">Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line"></span><br><span class="line"><span class="comment">//柔和相加</span></span><br><span class="line">Blend OneMinusDstColor One</span><br><span class="line"></span><br><span class="line"><span class="comment">//正片叠底，即相乘</span></span><br><span class="line">Blend DstColor Zero</span><br><span class="line"></span><br><span class="line"><span class="comment">//两倍相乘</span></span><br><span class="line">Blend DstColor SrcColor</span><br><span class="line"></span><br><span class="line"><span class="comment">//变暗，注意这里的混合因子无用，max也相同</span></span><br><span class="line">BlendOp Min</span><br><span class="line">Blend One One</span><br><span class="line"></span><br><span class="line"><span class="comment">//变亮</span></span><br><span class="line">BlendOp Max</span><br><span class="line">Blend One One</span><br><span class="line"></span><br><span class="line"><span class="comment">//滤色</span></span><br><span class="line">Blend OneMinusDstColor One</span><br><span class="line"></span><br><span class="line"><span class="comment">//等同于</span></span><br><span class="line">Blend One OneMinusSrcColor</span><br><span class="line"></span><br><span class="line"><span class="comment">//线性减淡 </span></span><br><span class="line">Blend One One</span><br></pre></td></tr></table></figure>

<p>下面是最常见的混合计算公式（一般而言是按透明度进行混合的，但是可以根据混合命令进行设置）：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled29.png" alt="Untitled"></p>
<ul>
<li>DstColor：颜色缓冲区的颜色</li>
<li>SrcAlpha：原颜色的混合因子：SrcFactor。可能是原颜色的透明度。</li>
<li>SrcColor：原颜色</li>
<li>DstColor：目标颜色；原本颜色缓冲区颜色</li>
<li>（1-SrcAlpha）：DstFactor，目标颜色的混合因子</li>
<li>注意：修改公式内容可以得到其他类型的混合公式与混合效果</li>
</ul>
<p>以下是透明度混合的部分部分UnityShader代码设置：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//由于透明度混合是（逐片元）可配置的，并非完全可编程的，所以只需要在Shader中设置好混合命令即可。</span></span><br><span class="line">Shader &quot;Unity Shaders Book/Chapter <span class="number">8</span>/Alpha Blend&quot; &#123;</span><br><span class="line">	Properties &#123;</span><br><span class="line">		....</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//像素半透明参数</span></span><br><span class="line">		_AlphaScale (&quot;Alpha Scale&quot;, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	SubShader &#123;</span><br><span class="line">		<span class="comment">//Queue设置为半透明Transparent</span></span><br><span class="line">		Tags &#123;&quot;Queue&quot;=&quot;Transparent&quot; &quot;IgnoreProjector&quot;=&quot;True&quot; &quot;RenderType&quot;=&quot;Transparent&quot;&#125;</span><br><span class="line">		</span><br><span class="line">		Pass &#123;</span><br><span class="line">			....</span><br><span class="line">			<span class="comment">//关闭深度写入</span></span><br><span class="line">			ZWrite Off</span><br><span class="line">			<span class="comment">//设置透明混合命令</span></span><br><span class="line">			Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line">			</span><br><span class="line">			....</span><br><span class="line">			fixed _AlphaScale;</span><br><span class="line">			....</span><br><span class="line">			</span><br><span class="line">			fixed4 frag(v2f i) : SV_Target &#123;</span><br><span class="line">				....</span><br><span class="line">				<span class="comment">//返回最后的合成颜色，并设置透明度通道=纹理像素的透明通道*材质参数_AlphaScale</span></span><br><span class="line">				<span class="keyword">return</span> fixed4(ambient + diffuse, texColor.a * _AlphaScale);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			ENDCG</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	FallBack &quot;Transparent/VertexLit&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="开启深度写入的半透明效果"><a href="#开启深度写入的半透明效果" class="headerlink" title="开启深度写入的半透明效果"></a>开启深度写入的半透明效果</h2><p>还记得之前在<code>存在的问题</code>小节中提到的问题吗？不同物体部分区域前后位置不一致导致的混合效果错误现象，是由于深度写入关闭的原因，解决方法就是开启深度写入了（- -“）。之前说了，之所以关闭深度写入是因为避免深度写入之后，将颜色缓冲区的旧颜色（目标颜色，后面物体的颜色）替换成深度较浅的前面物体的颜色。所以这里说的开启深度写入指的是将深度写入深度缓冲区，但是不进行包括颜色替换的其他任何操作。在实际实现中表现为单独使用一个Pass进行深度写入操作。部分代码如下：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unity Shaders Book/Chapter <span class="number">8</span>/Alpha Blend&quot; &#123;</span><br><span class="line">	Properties &#123;</span><br><span class="line">		....</span><br><span class="line"></span><br><span class="line">		<span class="comment">//像素半透明参数</span></span><br><span class="line">		_AlphaScale (&quot;Alpha Scale&quot;, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	SubShader &#123;</span><br><span class="line">		<span class="comment">//Queue设置为半透明Transparent</span></span><br><span class="line">		Tags &#123;&quot;Queue&quot;=&quot;Transparent&quot; &quot;IgnoreProjector&quot;=&quot;True&quot; &quot;RenderType&quot;=&quot;Transparent&quot;&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 只进行深度写入</span></span><br><span class="line">		Pass &#123;</span><br><span class="line">			<span class="comment">//打开深度写入</span></span><br><span class="line">			ZWrite On</span><br><span class="line"></span><br><span class="line">			<span class="comment">//渲染命令ColorMask，用于设置颜色通道的写掩码（write mask）</span></span><br><span class="line">			<span class="comment">//语义:ColorMask RGB|A|0|其他RGBA的组合</span></span><br><span class="line">			<span class="comment">//以下表示，该Pass不写入任何颜色通道，不会输出任何颜色</span></span><br><span class="line">			ColorMask <span class="number">0</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Pass &#123;</span><br><span class="line">			Tags &#123; &quot;LightMode&quot;=&quot;ForwardBase&quot; &#125;</span><br><span class="line">			<span class="comment">//关闭深度写入</span></span><br><span class="line">			ZWrite Off</span><br><span class="line">			<span class="comment">//设置透明混合命令</span></span><br><span class="line">			Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//其余部分操作与透明度混合相同</span></span><br><span class="line">			....</span><br><span class="line">		&#125; </span><br><span class="line">	&#125; </span><br><span class="line">	FallBack &quot;Transparent/VertexLit&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PS：这种深度写入能够完成不同顺序的物体之间的混合效果，但是在同一物体的遮挡混合中不能够实现混合，具体效果可以查看下方效果展示中的<code>透明度混合，深度写入</code>，除此之外，在透明效果中还需要注意透明应该需要能够看见当前透明物体的内部结构，这就需要使用到剔除的功能了，同样经过测试，开启了深度写入的同物体也不能展示双面不被剔除的显示效果（也就是关闭剔除之后，开启深度写入，没办法展示出<code>双面</code>的效果，反而与开启剔除效果相同），具体原因待探究。</p>
<h3 id="双面渲染的透明效果"><a href="#双面渲染的透明效果" class="headerlink" title="双面渲染的透明效果"></a>双面渲染的透明效果</h3><p>如果物体有透明效果。那么不但应该能够透过它看见其他物体的样子，还应该能够看见物体的内部结构。但是以上的渲染效果并不会实现这些功能，导致渲染的透明或半透明物体看上去只是半个物体（背面的半个消失了，如下图）</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled30.png" alt="Untitled"></p>
<p>这是因为物体渲染的时候开启了剔除（cull）功能，并且默认设置成了Back。让背对摄像机，摄像机看不见的部分不进行渲染。所以造成了透明效果的穿帮。</p>
<ul>
<li>Cull Back：开启背面剔除</li>
<li>Cull Front：开启正面剔除</li>
<li>Cull Off：关闭剔除</li>
</ul>
<p>以下是透明度测试的双面剔除的部分代码,效果展示可以再本节最下方查看：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Pass &#123;</span><br><span class="line">	Tags &#123; &quot;LightMode&quot;=&quot;ForwardBase&quot; &#125;</span><br><span class="line">			</span><br><span class="line">	<span class="comment">// 关闭剔除功能</span></span><br><span class="line">	Cull Off</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>透明度测试的剔除很简单，但是透明度混合不能够向透明度测试一样操作。这是因为透明度混合关闭了深度写入，为了保证同一个物体的渲染顺序，需要分成两个Pass分别进行正面剔除的渲染与背面剔除的渲染。部分代码如下：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unity Shaders Book/Chapter <span class="number">8</span>/Alpha Blend With Both Side&quot; &#123;</span><br><span class="line">	Properties &#123;</span><br><span class="line">		....</span><br><span class="line">		_AlphaScale (&quot;Alpha Scale&quot;, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	SubShader &#123;</span><br><span class="line">		Tags &#123;&quot;Queue&quot;=&quot;Transparent&quot; &quot;IgnoreProjector&quot;=&quot;True&quot; &quot;RenderType&quot;=&quot;Transparent&quot;&#125;</span><br><span class="line">		</span><br><span class="line">		Pass &#123;</span><br><span class="line">			Tags &#123; &quot;LightMode&quot;=&quot;ForwardBase&quot; &#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// First pass renders only back faces </span></span><br><span class="line">			Cull Front</span><br><span class="line">			</span><br><span class="line">			ZWrite Off</span><br><span class="line">			Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		Pass &#123;</span><br><span class="line">			Tags &#123; &quot;LightMode&quot;=&quot;ForwardBase&quot; &#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// Second pass renders only front faces </span></span><br><span class="line">			Cull Back</span><br><span class="line">			</span><br><span class="line">			ZWrite Off</span><br><span class="line">			Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	FallBack &quot;Transparent/VertexLit&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本章实现的透明效果如下：</p>
<p><img src="/img/loading.gif" data-original="../UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/Untitled31.png" alt="Untitled"></p>
<hr>
<h2 id="问题探究"><a href="#问题探究" class="headerlink" title="问题探究"></a>问题探究</h2><p>等unityShader总结全部整理好之后，会归纳一下可能不太熟悉的知识点或问题，看看能不能出个问题总结。这里先记录一下这部分内容学习遇上的问题，各位大佬有了解的也可以尝试在评论区进行评论。</p>
<ol>
<li>透明混合效果的阴影实现</li>
<li>开启深入写入的本物体无法进行透明混合，原因与是否有解决方法</li>
<li>uv坐标与tex2d（）的采样原理</li>
<li>UnityShader中定义的属性存储语义（这里指的是结构体中的POSITION等等）以及属性（这里指的是属性）相关的声明类型。</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://the-black-sun.github.io/">墨墨辰</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://the-black-sun.github.io/2023/10/07/UnityShader学习总结：基础初级篇/">https://the-black-sun.github.io/2023/10/07/UnityShader学习总结：基础初级篇/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">墨墨辰的旋转小屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Unity/">Unity</a><a class="post-meta__tags" href="/tags/Shader/">Shader</a><a class="post-meta__tags" href="/tags/%E5%9B%BE%E5%BD%A2%E6%B8%B2%E6%9F%93/">图形渲染</a></div><div class="post_share"><div class="social-share" data-image="https://the-black-sun-imgs.pages.dev/Img/1最初的梦想.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/10/28/%E6%8F%92%E4%BB%B6%E5%8D%95/" title="插件单"><img class="cover" src="/img/loading.gif" data-original="https://the-black-sun-imgs.pages.dev/Img/2集结的众人.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">插件单</div></div></a></div><div class="next-post pull-right"><a href="/2023/09/06/Lua%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" title="Lua学习总结"><img class="cover" src="/img/loading.gif" data-original="https://the-black-sun-imgs.pages.dev/Img/Lua.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Lua学习总结</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/09/05/Unity%E6%B8%B2%E6%9F%93%E9%A1%BA%E5%BA%8F%E6%8E%A2%E7%A9%B6/" title="Unity渲染顺序探究"><img class="cover" src="/img/loading.gif" data-original="https://the-black-sun-imgs.pages.dev/Img/Cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-05</div><div class="title">Unity渲染顺序探究</div></div></a></div><div><a href="/2023/10/28/%E6%8F%92%E4%BB%B6%E5%8D%95/" title="插件单"><img class="cover" src="/img/loading.gif" data-original="https://the-black-sun-imgs.pages.dev/Img/2集结的众人.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-28</div><div class="title">插件单</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/loading.gif" data-original="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">墨墨辰</div><div class="author-info__description">要看很多电影，要看很多的书，毕竟每天都很短暂。</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/The-Black-Sun" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://gitee.com/mo-mo-chen" target="_blank" title="Gitee"><i class="iconfont icon-gitee-fill-round"></i></a><a class="social-icon" href="https://blog.csdn.net/qq_43811969?type=blog" target="_blank" title="CSDN"><i class="iconfont icon-csdn"></i></a><a class="social-icon" href="https://weibo.com/u/6067520395" target="_blank" title="Weibo"><i class="iconfont icon-xinlangweibo"></i></a><a class="social-icon" href="https://www.zhihu.com/people/qun-xing-bu-zhi-hai" target="_blank" title="Zhihu"><i class="iconfont icon-zhihu"></i></a><a class="social-icon" href="https://space.bilibili.com/346405803?spm_id_from=333.1007.0.0" target="_blank" title="Bilibili"><i class="iconfont icon-bilibili-line"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">第一篇博文发布了！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%83%A8%E5%88%86%EF%BC%9A%E6%B8%B2%E6%9F%93%E6%B5%81%E6%B0%B4%E7%BA%BF%E4%B8%8EUnity-Sahder%E5%9F%BA%E7%A1%80"><span class="toc-number">2.</span> <span class="toc-text">基础部分：渲染流水线与Unity Sahder基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="toc-number">2.1.</span> <span class="toc-text">渲染流水线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unity-Shader%E5%9F%BA%E7%A1%80"><span class="toc-number">2.2.</span> <span class="toc-text">Unity Shader基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99"><span class="toc-number">2.2.1.</span> <span class="toc-text">相关资料</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9D%E7%BA%A7%E9%83%A8%E5%88%86%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7%E4%B8%8E%E5%9F%BA%E7%A1%80%E7%BA%B9%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">初级部分：基础光照与基础纹理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7"><span class="toc-number">3.1.</span> <span class="toc-text">基础光照</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%AB%E5%8F%8D%E5%B0%84"><span class="toc-number">3.1.1.</span> <span class="toc-text">漫反射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%85%89%E5%8F%8D%E5%B0%84"><span class="toc-number">3.1.2.</span> <span class="toc-text">高光反射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unity%E5%B8%B8%E7%94%A8%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.3.</span> <span class="toc-text">Unity常用内置函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%BA%B9%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">基础纹理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E5%BC%A0%E7%BA%B9%E7%90%86%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">3.2.1.</span> <span class="toc-text">单张纹理的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E6%B8%90%E8%BF%9C%E7%BA%B9%E7%90%86%EF%BC%88mipmapping%EF%BC%89%E6%8A%80%E6%9C%AF%EF%BC%88%E6%9C%89%E7%82%B9%E5%83%8Flod%E6%8A%80%E6%9C%AF%EF%BC%8C%E2%87%92Levels-of-Detail%EF%BC%89"><span class="toc-number">3.2.2.</span> <span class="toc-text">多级渐远纹理（mipmapping）技术（有点像lod技术，⇒Levels of Detail）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%B9%E5%87%B8%E6%98%A0%E5%B0%84%EF%BC%88%E9%AB%98%E5%BA%A6%E5%9B%BE%EF%BC%8C%E6%B3%95%E7%BA%BF%E7%BA%B9%E7%90%86%EF%BC%89"><span class="toc-number">3.2.3.</span> <span class="toc-text">凹凸映射（高度图，法线纹理）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%90%E5%8F%98%E7%BA%B9%E7%90%86"><span class="toc-number">3.2.4.</span> <span class="toc-text">渐变纹理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%AE%E7%BD%A9%E7%BA%B9%E7%90%86"><span class="toc-number">3.2.5.</span> <span class="toc-text">遮罩纹理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%8F%E6%98%8E%E6%B5%8B%E8%AF%95%E3%80%81%E6%B7%B7%E5%90%88%E4%B8%8E%E9%9D%A2%E5%89%94%E9%99%A4"><span class="toc-number">3.3.</span> <span class="toc-text">透明测试、混合与面剔除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E5%BA%A6%E5%86%99%E5%85%A5%E4%B8%8E%E6%B8%B2%E6%9F%93%E9%A1%BA%E5%BA%8F"><span class="toc-number">3.3.1.</span> <span class="toc-text">深度写入与渲染顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">3.3.2.</span> <span class="toc-text">存在的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UnityShader%E7%9A%84%E6%B8%B2%E6%9F%93%E9%98%9F%E5%88%97"><span class="toc-number">3.3.3.</span> <span class="toc-text">UnityShader的渲染队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%8F%E6%98%8E%E5%BA%A6%E6%B5%8B%E8%AF%95"><span class="toc-number">3.3.4.</span> <span class="toc-text">透明度测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%8F%E6%98%8E%E5%BA%A6%E6%B7%B7%E5%90%88"><span class="toc-number">3.3.5.</span> <span class="toc-text">透明度混合</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E6%B7%B1%E5%BA%A6%E5%86%99%E5%85%A5%E7%9A%84%E5%8D%8A%E9%80%8F%E6%98%8E%E6%95%88%E6%9E%9C"><span class="toc-number">3.4.</span> <span class="toc-text">开启深度写入的半透明效果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E9%9D%A2%E6%B8%B2%E6%9F%93%E7%9A%84%E9%80%8F%E6%98%8E%E6%95%88%E6%9E%9C"><span class="toc-number">3.4.1.</span> <span class="toc-text">双面渲染的透明效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8E%A2%E7%A9%B6"><span class="toc-number">3.5.</span> <span class="toc-text">问题探究</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/10/28/%E6%8F%92%E4%BB%B6%E5%8D%95/" title="插件单"><img src="/img/loading.gif" data-original="https://the-black-sun-imgs.pages.dev/Img/2集结的众人.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="插件单"/></a><div class="content"><a class="title" href="/2023/10/28/%E6%8F%92%E4%BB%B6%E5%8D%95/" title="插件单">插件单</a><time datetime="2023-10-28T06:21:39.000Z" title="发表于 2023-10-28 14:21:39">2023-10-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/07/UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/" title="UnityShader学习总结：基础初级篇"><img src="/img/loading.gif" data-original="https://the-black-sun-imgs.pages.dev/Img/1最初的梦想.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UnityShader学习总结：基础初级篇"/></a><div class="content"><a class="title" href="/2023/10/07/UnityShader%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%88%9D%E7%BA%A7%E7%AF%87/" title="UnityShader学习总结：基础初级篇">UnityShader学习总结：基础初级篇</a><time datetime="2023-10-07T11:58:04.000Z" title="发表于 2023-10-07 19:58:04">2023-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/06/Lua%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" title="Lua学习总结"><img src="/img/loading.gif" data-original="https://the-black-sun-imgs.pages.dev/Img/Lua.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Lua学习总结"/></a><div class="content"><a class="title" href="/2023/09/06/Lua%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" title="Lua学习总结">Lua学习总结</a><time datetime="2023-09-06T12:54:23.000Z" title="发表于 2023-09-06 20:54:23">2023-09-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/05/Unity%E6%B8%B2%E6%9F%93%E9%A1%BA%E5%BA%8F%E6%8E%A2%E7%A9%B6/" title="Unity渲染顺序探究"><img src="/img/loading.gif" data-original="https://the-black-sun-imgs.pages.dev/Img/Cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Unity渲染顺序探究"/></a><div class="content"><a class="title" href="/2023/09/05/Unity%E6%B8%B2%E6%9F%93%E9%A1%BA%E5%BA%8F%E6%8E%A2%E7%A9%B6/" title="Unity渲染顺序探究">Unity渲染顺序探究</a><time datetime="2023-09-05T12:26:33.000Z" title="发表于 2023-09-05 20:26:33">2023-09-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/06/A-%E7%AE%97%E6%B3%95/" title="A*算法"><img src="/img/loading.gif" data-original="https://file.crazywong.com/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="A*算法"/></a><div class="content"><a class="title" href="/2023/08/06/A-%E7%AE%97%E6%B3%95/" title="A*算法">A*算法</a><time datetime="2023-08-06T07:40:29.000Z" title="发表于 2023-08-06 15:40:29">2023-08-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 墨墨辰</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://the-black-sun.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'ccc3a8f7dffa8fffff16',
      clientSecret: '6d421ff290891992e3f652f6312b26b0d48fcd4d',
      repo: 'BlogComment',
      owner: 'The-Black-Sun',
      admin: ['The-Black-Sun'],
      id: '81c6bfa5958a0e1d25022899d88a11bb',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><div class="aplayer no-destroy" data-id="8740452027" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script>window.$crisp = [];
window.CRISP_WEBSITE_ID = "bdf92193-4b73-4fe9-bd0e-12ac3ada3c1c";
(function () {
  d = document;
  s = d.createElement("script");
  s.src = "https://client.crisp.chat/l.js";
  s.async = 1;
  d.getElementsByTagName("head")[0].appendChild(s);
})();
$crisp.push(["safe", true])

if (true) {
  $crisp.push(["do", "chat:hide"])
  $crisp.push(["on", "chat:closed", function() {
    $crisp.push(["do", "chat:hide"])
  }])
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      $crisp.push(["do", "chat:show"])
      $crisp.push(["do", "chat:open"])

    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      $crisp.push(["do", "chat:hide"])
    }
    function chatBtnShow () {
      $crisp.push(["do", "chat:show"])
    }
  }
}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body></html><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script>